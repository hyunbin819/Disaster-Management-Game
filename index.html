<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¬ë‚œ ê´€ë¦¬ ì¹´ë“œ ê²Œì„ (Online Multiplayer)</title>
    <style>
        /* ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€ + ë¡œë¹„ ìŠ¤íƒ€ì¼ ì¶”ê°€ */
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; }
        
        /* ë¡œë¹„ í™”ë©´ (ë°© ë§Œë“¤ê¸°/ì°¸ê°€) */
        #lobby-screen {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: #1e3c72; color: white; z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .lobby-box { background: white; color: #333; padding: 40px; border-radius: 15px; text-align: center; width: 300px; }
        .lobby-box input { width: 100%; padding: 10px; margin: 10px 0; font-size: 1.2em; text-align: center; }
        .lobby-btn { width: 100%; padding: 15px; margin: 5px 0; font-size: 1.1em; cursor: pointer; border: none; border-radius: 5px; color: white; }
        #create-room-btn { background-color: #28a745; }
        #join-room-btn { background-color: #007bff; }

        /* ê²Œì„ í™”ë©´ ë“± ê¸°ì¡´ ìŠ¤íƒ€ì¼ */
        #game-container { display: none; max-width: 1000px; margin: 0 auto; background-color: #f0f2f5; padding: 20px; border-radius: 15px; }
        .player-area { border: 2px solid #ccc; border-radius: 10px; padding: 20px; margin-bottom: 20px; background-color: #fff; }
        .player-area.active-turn { border: 3px solid #007bff; box-shadow: 0 0 15px rgba(0,123,255,0.3); }
        .status-bar { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 10px; }
        .card-container { display: flex; flex-wrap: wrap; gap: 10px; min-height: 120px; background: #f8f9fa; padding: 10px; border-radius: 8px; }
        .card { width: 100px; height: 140px; background: white; border: 1px solid #ddd; border-radius: 8px; padding: 5px; cursor: pointer; display: flex; flex-direction: column; justify-content: space-between; font-size: 0.8em; }
        .card:hover { transform: translateY(-5px); }
        .card.selected { border: 3px solid #007bff; background: #e3f2fd; }
        .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        button { padding: 10px; cursor: pointer; font-size: 1em; }
        #message-log { height: 100px; overflow-y: scroll; background: white; border: 1px solid #ddd; padding: 10px; margin-top: 10px; }
        .waiting-overlay { position: absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); color:white; display:flex; justify-content:center; align-items:center; font-size:2em; z-index:100; display:none; }
    </style>
</head>
<body>

    <div id="lobby-screen">
        <div class="lobby-box">
            <h1>ì¬ë‚œ ì¹´ë“œ ê²Œì„</h1>
            <p>ì˜¨ë¼ì¸ ë©€í‹°í”Œë ˆì´</p>
            <input type="text" id="room-id-input" placeholder="ë°© ì´ë¦„ ì…ë ¥ (ì˜ˆ: room1)">
            <button id="create-room-btn" class="lobby-btn">ë°© ë§Œë“¤ê¸° (ë°©ì¥)</button>
            <button id="join-room-btn" class="lobby-btn">ë°© ì°¸ê°€í•˜ê¸° (ë„ì „ì)</button>
        </div>
    </div>

    <div id="game-container">
        <div id="waiting-msg" class="waiting-overlay">ìƒëŒ€ë°©ì„ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...</div>
        
        <div class="player-area" id="opponent-area">
            <div class="status-bar">
                <h3>ìƒëŒ€ë°© (<span id="opp-role">Guest</span>)</h3>
                <div>ì²´ë ¥: <span id="opp-hp">2000</span> | ëˆ: <span id="opp-money">1000</span></div>
            </div>
            <div id="opp-hand" class="card-container" style="background:#ddd;">ì¹´ë“œ ë’·ë©´ë§Œ ë³´ì„</div>
        </div>

        <div class="player-area active-turn" id="my-area">
            <div class="status-bar">
                <h3>ë‚˜ (<span id="my-role">Host</span>)</h3>
                <div>ì²´ë ¥: <span id="my-hp">2000</span> | ëˆ: <span id="my-money">1000</span></div>
            </div>
            <div id="my-hand" class="card-container"></div>
        </div>

        <div class="controls">
            <button id="atk-btn" onclick="attack()">ê³µê²© í…ŒìŠ¤íŠ¸ (10 ë°ë¯¸ì§€)</button>
            <button id="turn-end-btn" onclick="endTurn()">í„´ ë„˜ê¸°ê¸°</button>
        </div>
        <div id="message-log"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, update } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // ============================================================
        // ğŸ”¥ [ì¤‘ìš”] ì—¬ê¸°ì— Firebase ì„¤ì •ê°’ì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš” ğŸ”¥
        // ============================================================
        const firebaseConfig = {
          apiKey: "AIzaSyBmAUvLNMXYGS5674lob7kZzzkLH4ctYBU",
          authDomain: "disaster-game-online.firebaseapp.com",
          projectId: "disaster-game-online",
          storageBucket: "disaster-game-online.firebasestorage.app",
          messagingSenderId: "557399169778",
          appId: "1:557399169778:web:809b8f4444cbbc6b14ce6b",
          measurementId: "G-PCF2JDM9HF"
        };
        // ============================================================

        // Firebase ì´ˆê¸°í™”
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // ê²Œì„ ìƒíƒœ ë³€ìˆ˜
        let roomId = "";
        let myRole = ""; // 'host' (ë°©ì¥) or 'guest' (ì°¸ê°€ì)
        let isMyTurn = false;
        let gameState = {
            turn: 'host', // ëˆ„êµ¬ í„´ì¸ì§€
            host: { hp: 2000, money: 1000 },
            guest: { hp: 2000, money: 1000 },
            log: "ê²Œì„ ëŒ€ê¸° ì¤‘..."
        };

        // DOM ìš”ì†Œ
        const lobbyScreen = document.getElementById('lobby-screen');
        const gameContainer = document.getElementById('game-container');
        const roomInput = document.getElementById('room-id-input');
        const msgLog = document.getElementById('message-log');

        // 1. ë°© ë§Œë“¤ê¸° (Host)
        document.getElementById('create-room-btn').addEventListener('click', () => {
            roomId = roomInput.value;
            if(!roomId) return alert("ë°© ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”!");
            
            myRole = 'host';
            document.getElementById('my-role').innerText = "Host (ë‚˜)";
            document.getElementById('opp-role').innerText = "Guest (ìƒëŒ€)";
            
            // DBì— ë°© ì´ˆê¸°í™”
            set(ref(db, 'rooms/' + roomId), gameState);
            
            startGameUI();
        });

        // 2. ë°© ì°¸ê°€í•˜ê¸° (Guest)
        document.getElementById('join-room-btn').addEventListener('click', () => {
            roomId = roomInput.value;
            if(!roomId) return alert("ë°© ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”!");

            myRole = 'guest';
            document.getElementById('my-role').innerText = "Guest (ë‚˜)";
            document.getElementById('opp-role').innerText = "Host (ìƒëŒ€)";
            
            startGameUI();
        });

        function startGameUI() {
            lobbyScreen.style.display = 'none';
            gameContainer.style.display = 'block';
            listenGameData(); // ë°ì´í„° ë™ê¸°í™” ì‹œì‘
        }

        // 3. ë°ì´í„° ë™ê¸°í™” (í•µì‹¬ ë¡œì§)
        function listenGameData() {
            const roomRef = ref(db, 'rooms/' + roomId);
            
            onValue(roomRef, (snapshot) => {
                const data = snapshot.val();
                if (!data) return; // ë°ì´í„° ì—†ìŒ

                // í™”ë©´ ì—…ë°ì´íŠ¸
                document.getElementById('my-hp').innerText = data[myRole].hp;
                document.getElementById('my-money').innerText = data[myRole].money;
                
                const oppRole = (myRole === 'host') ? 'guest' : 'host';
                document.getElementById('opp-hp').innerText = data[oppRole].hp;
                document.getElementById('opp-money').innerText = data[oppRole].money;

                // í„´ í™•ì¸
                isMyTurn = (data.turn === myRole);
                document.getElementById('my-area').style.borderColor = isMyTurn ? '#007bff' : '#ccc';
                document.getElementById('atk-btn').disabled = !isMyTurn;
                document.getElementById('turn-end-btn').disabled = !isMyTurn;

                // ë¡œê·¸ ì¶œë ¥
                if(msgLog.lastChild?.innerText !== data.log) {
                    const p = document.createElement('p');
                    p.innerText = data.log;
                    msgLog.appendChild(p);
                    msgLog.scrollTop = msgLog.scrollHeight;
                }
            });
        }

        // 4. ì•¡ì…˜ (ê³µê²© í…ŒìŠ¤íŠ¸)
        window.attack = function() {
            if(!isMyTurn) return;
            
            const oppRole = (myRole === 'host') ? 'guest' : 'host';
            
            // í˜„ì¬ ìƒíƒœ ì½ì–´ì˜¤ê¸° (ê°„ë‹¨í•˜ê²Œ êµ¬í˜„í•˜ê¸° ìœ„í•´ ë°”ë¡œ ì—…ë°ì´íŠ¸ ì‚¬ìš©)
            // ì‹¤ì œë¡œëŠ” íŠ¸ëœì­ì…˜ì„ ì“°ëŠ”ê²Œ ì•ˆì „í•˜ì§€ë§Œ ì—¬ê¸°ì„  updateë¡œ ì²˜ë¦¬
            // ìƒëŒ€ë°© ì²´ë ¥ì„ 10 ê¹ìŒ
            const updates = {};
            
            // ì£¼ì˜: DBì—ì„œ ê°’ì„ ë¨¼ì € ì½ì–´ì™€ì•¼ ì •í™•í•˜ì§€ë§Œ, ì—¬ê¸°ì„  í¸ì˜ìƒ í™”ë©´ ê°’ì„ ì°¸ì¡°
            // ì‹¤ì œ êµ¬í˜„ ì‹œì—ëŠ” snapshot ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ê³„ì‚°í•´ì•¼ í•¨
            const currentOppHp = parseInt(document.getElementById('opp-hp').innerText);
            
            updates[`rooms/${roomId}/${oppRole}/hp`] = currentOppHp - 10;
            updates[`rooms/${roomId}/log`] = `${myRole}ê°€ ê³µê²©í–ˆìŠµë‹ˆë‹¤! (10 í”¼í•´)`;
            
            update(ref(db), updates);
        };

        // 5. í„´ ë„˜ê¸°ê¸°
        window.endTurn = function() {
            if(!isMyTurn) return;
            const nextTurn = (myRole === 'host') ? 'guest' : 'host';
            
            const updates = {};
            updates[`rooms/${roomId}/turn`] = nextTurn;
            updates[`rooms/${roomId}/log`] = `í„´ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤: ${nextTurn}ì˜ ì°¨ë¡€`;
            
            update(ref(db), updates);
        }
    </script>
</body>
</html>
