<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¬ë‚œ ê´€ë¦¬ ì¹´ë“œ ê²Œì„ (Online Full Version)</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background-color: #f0f2f5; margin: 0; padding: 0; }

        /* === 1. ë¡œë¹„ & ì¸íŠ¸ë¡œ ìŠ¤íƒ€ì¼ === */
        #intro-screen {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white; z-index: 5000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .intro-box {
            background-color: rgba(255, 255, 255, 0.95); color: #333;
            padding: 40px; border-radius: 20px; text-align: center;
            width: 90%; max-width: 500px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .intro-input { width: 80%; padding: 15px; font-size: 1.2em; margin: 10px 0; border: 2px solid #ddd; border-radius: 8px; text-align: center; }
        .intro-btn { width: 90%; padding: 15px; font-size: 1.2em; margin: 5px 0; border: none; border-radius: 50px; cursor: pointer; font-weight: bold; color: white; transition: 0.2s; }
        #create-btn { background-color: #28a745; }
        #join-btn { background-color: #007bff; }
        .intro-btn:hover { transform: scale(1.05); filter: brightness(1.1); }

        /* === 2. ê²Œì„ í™”ë©´ ìŠ¤íƒ€ì¼ === */
        #game-container { display: none; max-width: 1000px; margin: 20px auto; background-color: #f0f2f5; padding: 20px; border-radius: 15px; }
        
        .active-turn-indicator {
            position: fixed; top: 0; left: 0; width: 100%; padding: 10px;
            text-align: center; color: white; font-weight: bold; font-size: 1.2em; z-index: 1000;
        }
        .turn-my { background-color: #007bff; }
        .turn-opp { background-color: #dc3545; }

        .player-area { border: 2px solid #ccc; border-radius: 10px; padding: 20px; margin-bottom: 20px; background-color: #fff; position: relative; }
        .player-area.active-turn { border: 4px solid #007bff; box-shadow: 0 0 20px rgba(0,123,255,0.2); }
        
        .status-bar { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 10px; }
        .city-badge { font-size: 0.8em; background-color: #495057; color: white; padding: 5px 10px; border-radius: 15px; margin-left: 10px; }
        .weakness { color: #ff6b6b; font-weight: bold; font-size: 0.9em; }

        .card-container { display: flex; flex-wrap: wrap; gap: 10px; min-height: 140px; background: #f8f9fa; padding: 15px; border-radius: 8px; }
        .card {
            width: 100px; height: 150px; background: white; border: 2px solid #ddd; border-radius: 8px; 
            padding: 5px; cursor: pointer; display: flex; flex-direction: column; justify-content: space-between; 
            font-size: 0.85em; user-select: none; transition: transform 0.1s;
        }
        .card:hover { transform: translateY(-5px); z-index: 10; }
        .card.selected { border: 3px solid #007bff !important; background-color: #e3f2fd !important; transform: scale(1.05); }
        
        .card.type-disaster { border-left: 5px solid #dc3545; }
        .card.type-mitigation { border-left: 5px solid #28a745; }
        .card.type-general { border-left: 5px solid #ffc107; }

        /* ë’·ë©´ ì¹´ë“œ (ìƒëŒ€ë°©) */
        .card.hidden { background: #555; border: 2px solid #444; justify-content: center; align-items: center; }
        .card.hidden::after { content: "CARD"; color: #888; font-weight: bold; }
        .card.hidden * { display: none; }

        #controls { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px; margin-top: 20px; }
        .control-btn { padding: 15px; font-size: 1em; font-weight: bold; border: none; border-radius: 8px; color: white; cursor: pointer; }
        .control-btn:disabled { background-color: #ccc !important; cursor: not-allowed; }
        #play-btn { background-color: #28a745; grid-column: span 2; }
        #draw-btn { background-color: #007bff; }
        #end-btn { background-color: #dc3545; }

        #active-news-ticker { background: #fff3cd; color: #856404; padding: 10px; text-align: center; border-radius: 8px; margin-bottom: 20px; font-weight: bold; }
        
        #message-log { height: 150px; overflow-y: scroll; background: white; border: 1px solid #ddd; padding: 10px; margin-top: 20px; font-size: 0.9em; border-radius: 8px; }
        .log-sys { color: #666; font-style: italic; }
        .log-atk { color: #d32f2f; font-weight: bold; }
        .log-def { color: #28a745; font-weight: bold; }

        /* ê²°ê³¼ í™”ë©´ */
        #result-modal {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.9); z-index: 6000; color: white;
            display: none; flex-direction: column; justify-content: center; align-items: center;
        }
        .result-box { background: #333; padding: 40px; border-radius: 20px; text-align: center; border: 2px solid gold; }
    </style>
</head>
<body>

    <div id="intro-screen">
        <div class="intro-box">
            <h1>ğŸŒªï¸ ì¬ë‚œ ì¹´ë“œ ê²Œì„ Online</h1>
            <p>ë°© ì´ë¦„ì„ ì…ë ¥í•˜ì—¬ ì¹œêµ¬ì™€ ì—°ê²°í•˜ì„¸ìš”.</p>
            <input type="text" id="room-input" class="intro-input" placeholder="ë°© ì´ë¦„ (ì˜ˆ: myroom)">
            <button id="create-btn" class="intro-btn">ë°© ë§Œë“¤ê¸° (Host)</button>
            <button id="join-btn" class="intro-btn">ë°© ì°¸ê°€í•˜ê¸° (Guest)</button>
            <p style="font-size:0.8em; color:#666; margin-top:20px;">*ê°™ì€ ë°© ì´ë¦„ì„ ì…ë ¥í•´ì•¼ ë§Œë‚  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        </div>
    </div>

    <div id="turn-indicator" class="active-turn-indicator" style="display:none;">ê²Œì„ ëŒ€ê¸° ì¤‘...</div>

    <div id="game-container">
        
        <div id="active-news-ticker">ğŸ“° ë‰´ìŠ¤: ê²Œì„ ì‹œì‘ ëŒ€ê¸° ì¤‘...</div>

        <div id="opponent-area" class="player-area">
            <div class="status-bar">
                <div>
                    <span style="font-size:1.5em; font-weight:bold;">ğŸ‘¤ ìƒëŒ€ë°©</span>
                    <span id="opp-city" class="city-badge">ë„ì‹œ ì •ë³´</span>
                </div>
                <div style="text-align:right;">
                    <div>ğŸ’” í”¼í•´: <span id="opp-damage" style="color:#dc3545; font-weight:bold;">0</span></div>
                    <div>ğŸ’° ì˜ˆì‚°: <span id="opp-money" style="color:#28a745; font-weight:bold;">0</span></div>
                </div>
            </div>
            <div class="area-title" style="font-size:0.9em; color:#666;">ìƒëŒ€ë°© ì„¤ì¹˜ ì‹œì„¤</div>
            <div id="opp-field" class="card-container" style="min-height:100px; margin-bottom:10px;"></div>
            <div class="area-title" style="font-size:0.9em; color:#666;">ìƒëŒ€ë°© ì†íŒ¨</div>
            <div id="opp-hand" class="card-container" style="background:#e9ecef;"></div>
        </div>

        <div id="my-area" class="player-area">
            <div class="status-bar">
                <div>
                    <span style="font-size:1.5em; font-weight:bold; color:#007bff;">ME ë‚˜</span>
                    <span id="my-city" class="city-badge">ë„ì‹œ ì •ë³´</span>
                </div>
                <div style="text-align:right;">
                    <div>âš¡ AP: <span id="my-ap" style="color:#007bff; font-weight:bold;">0</span></div>
                    <div>ğŸ’” í”¼í•´: <span id="my-damage" style="color:#dc3545; font-weight:bold;">0</span></div>
                    <div>ğŸ’° ì˜ˆì‚°: <span id="my-money" style="color:#28a745; font-weight:bold;">0</span></div>
                </div>
            </div>
            <div class="area-title" style="font-size:0.9em; color:#666;">ë‚´ ì„¤ì¹˜ ì‹œì„¤</div>
            <div id="my-field" class="card-container" style="min-height:100px; margin-bottom:10px;"></div>
            <div class="area-title" style="font-size:0.9em; color:#666;">ë‚´ ì†íŒ¨ (í´ë¦­í•˜ì—¬ ì„ íƒ)</div>
            <div id="my-hand" class="card-container"></div>
        </div>

        <div id="controls">
            <button id="play-btn" class="control-btn">ì¹´ë“œ ì‚¬ìš© (1 AP)</button>
            <button id="draw-btn" class="control-btn">ì¹´ë“œ ë½‘ê¸° (1 AP)</button>
            <button id="end-btn" class="control-btn">í„´ ì¢…ë£Œ</button>
        </div>

        <div id="message-log"></div>
    </div>

    <div id="result-modal">
        <div class="result-box">
            <h1 id="result-title">ê²Œì„ ì¢…ë£Œ</h1>
            <p id="result-desc"></p>
            <button onclick="location.reload()" style="padding:10px 30px; margin-top:20px; cursor:pointer;">ë¡œë¹„ë¡œ ëŒì•„ê°€ê¸°</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, update, get } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // ============================================================
        // ğŸ”¥ [ì¤‘ìš”] ì—¬ê¸°ì— Firebase ì„¤ì •ê°’ì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš” ğŸ”¥
        // ============================================================
        const firebaseConfig = {
          apiKey: "AIzaSyBmAUvLNMXYGS5674lob7kZzzkLH4ctYBU",
          authDomain: "disaster-game-online.firebaseapp.com",
          projectId: "disaster-game-online",
          storageBucket: "disaster-game-online.firebasestorage.app",
          messagingSenderId: "557399169778",
          appId: "1:557399169778:web:809b8f4444cbbc6b14ce6b",
          databaseURL: "https://disaster-game-online-default-rtdb.firebaseio.com",
          measurementId: "G-PCF2JDM9HF"
        };
        // ============================================================

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- ê²Œì„ ë°ì´í„° ìƒìˆ˜ ---
        const DisasterType = { WINTER: "ê²¨ìš¸ì²  ì¬ë‚œ", WIND_FLOOD: "í’ìˆ˜í•´", MOUNTAIN: "ì‚°ì•… ì¬ë‚œ" };
        const MitigationPhase = { PREVENTION: "ì˜ˆë°©", PREPAREDNESS: "ì¤€ë¹„", GENERAL: "ë²”ìš©" };
        
        const CITY_TYPES = [
            { name: "ğŸŒŠ í•´ì•ˆ ë„ì‹œ", weakType: DisasterType.WIND_FLOOD, weakText: "í’ìˆ˜í•´ ì·¨ì•½" },
            { name: "ğŸšï¸ ë…¸í›„ ë„ì‹¬", weakType: DisasterType.WINTER, weakText: "ê²¨ìš¸ì²  ì·¨ì•½" },
            { name: "â›°ï¸ ì‚°ê°„ ì§€ì—­", weakType: DisasterType.MOUNTAIN, weakText: "ì‚°ì•… ì·¨ì•½" }
        ];

        const EVENTS = [
            { id: 'normal', name: "â˜€ï¸ í‰ì˜¨í•œ ë‚ ", desc: "íŠ¹ì´ ì‚¬í•­ ì—†ìŒ", type: "normal", val: 0 },
            { id: 'climate', name: "âš ï¸ ê¸°í›„ ì´ìƒ", desc: "ì¬ë‚œ ê³µê²©ë ¥ 1.5ë°°", type: "attack_buff", val: 1.5 },
            { id: 'inflation', name: "ğŸ’¸ ë¬¼ê°€ ìƒìŠ¹", desc: "ì‹œì„¤ ë¹„ìš© +50", type: "cost_up", val: 50 },
            { id: 'tech', name: "ğŸ’¡ ê¸°ìˆ  í˜ì‹ ", desc: "ì‹œì„¤ ë¹„ìš© -50", type: "cost_down", val: 50 },
        ];

        // --- ì „ì—­ ë³€ìˆ˜ ---
        let roomId = "";
        let myRole = ""; // 'host' or 'guest'
        let gameData = null;
        let selectedCardIds = [];

        // --- ì¹´ë“œ ìƒì„± í•¨ìˆ˜ë“¤ ---
        function createDeck() {
            let cards = [];
            const add = (c) => cards.push({...c, id: `c_${Date.now()}_${Math.random().toString(36).substr(2,9)}`});
            
            // ì¬ë‚œ (4ì„¸íŠ¸)
            const disasters = [
                {name:"ëŒ€ì„¤", type:"disaster", dType:DisasterType.WINTER, dmg:50},
                {name:"í•œíŒŒ", type:"disaster", dType:DisasterType.WINTER, dmg:50},
                {name:"í­ìš°", type:"disaster", dType:DisasterType.WIND_FLOOD, dmg:50},
                {name:"íƒœí’", type:"disaster", dType:DisasterType.WIND_FLOOD, dmg:50},
                {name:"ì‚°ë¶ˆ", type:"disaster", dType:DisasterType.MOUNTAIN, dmg:50},
                {name:"ì‚°ì‚¬íƒœ", type:"disaster", dType:DisasterType.MOUNTAIN, dmg:50}
            ];
            for(let i=0; i<4; i++) disasters.forEach(d => add(d));

            // ë°©ì¬ (3ì„¸íŠ¸)
            const mitigations = [
                {name:"ë„ë¡œ ì—´ì„ ", type:"mitigation", subType:"specific", target:"ëŒ€ì„¤", phase:MitigationPhase.PREVENTION, cost:200, power:150},
                {name:"ì œì„¤ ì¥ë¹„", type:"mitigation", subType:"specific", target:"ëŒ€ì„¤", phase:MitigationPhase.PREPAREDNESS, cost:50, power:30},
                {name:"ë°©íŒŒì œ ë³´ê°•", type:"mitigation", subType:"specific", target:"íƒœí’", phase:MitigationPhase.PREVENTION, cost:200, power:150},
                {name:"ì°½ë¬¸ ë³´ê°•", type:"mitigation", subType:"specific", target:"íƒœí’", phase:MitigationPhase.PREPAREDNESS, cost:50, power:30},
                {name:"ë°©í™”ì„  êµ¬ì¶•", type:"mitigation", subType:"specific", target:"ì‚°ë¶ˆ", phase:MitigationPhase.PREVENTION, cost:200, power:150},
                {name:"ì…ì‚° í†µì œ", type:"mitigation", subType:"specific", target:"ì‚°ë¶ˆ", phase:MitigationPhase.PREPAREDNESS, cost:50, power:30},
                // ... (ë¶„ëŸ‰ìƒ í•µì‹¬ ì¹´ë“œ ìœ„ì£¼ë¡œ êµ¬ì„±, ì‹¤ì œë¡œëŠ” ë” ì¶”ê°€ ê°€ëŠ¥)
            ];
            for(let i=0; i<3; i++) mitigations.forEach(m => add(m));
            
            // ë²”ìš© (1ì„¸íŠ¸)
            add({name:"í†µí•© ì‹œìŠ¤í…œ", type:"general", cost:150, power:80});
            add({name:"ì•ˆì „ êµìœ¡", type:"general", cost:100, power:50});

            // ì…”í”Œ
            return cards.sort(() => Math.random() - 0.5);
        }

        // --- ë¡œë¹„ ë¡œì§ ---
        const introScreen = document.getElementById('intro-screen');
        const roomInput = document.getElementById('room-input');

        document.getElementById('create-btn').addEventListener('click', async () => {
            roomId = roomInput.value;
            if(!roomId) return alert("ë°© ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.");
            myRole = 'host';
            await initGame();
        });

        document.getElementById('join-btn').addEventListener('click', () => {
            roomId = roomInput.value;
            if(!roomId) return alert("ë°© ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.");
            myRole = 'guest';
            connectGame();
        });

        async function initGame() {
            // ë°©ì¥: ì´ˆê¸° ê²Œì„ ìƒíƒœ ìƒì„± í›„ ì—…ë¡œë“œ
            const deck = createDeck();
            const hostHand = deck.splice(0, 6);
            const guestHand = deck.splice(0, 6);

            const initialState = {
                status: 'playing',
                turn: 'host',
                turnCount: 1,
                currentEvent: EVENTS[0],
                deck: deck,
                host: {
                    name: 'Host', hp: 0, money: 1000, ap: 2,
                    city: CITY_TYPES[Math.floor(Math.random()*3)],
                    hand: hostHand, field: []
                },
                guest: {
                    name: 'Guest', hp: 0, money: 1200, ap: 2, // ë°¸ëŸ°ìŠ¤ íŒ¨ì¹˜ +200
                    city: CITY_TYPES[Math.floor(Math.random()*3)],
                    hand: guestHand, field: []
                },
                log: "ê²Œì„ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤."
            };

            await set(ref(db, `rooms/${roomId}`), initialState);
            connectGame();
        }

        function connectGame() {
            introScreen.style.display = 'none';
            document.getElementById('game-container').style.display = 'block';
            document.getElementById('turn-indicator').style.display = 'block';

            onValue(ref(db, `rooms/${roomId}`), (snap) => {
                gameData = snap.val();
                if(!gameData) return alert("ë°©ì´ ì¡´ì¬í•˜ì§€ ì•Šê±°ë‚˜ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                renderGame();
                checkGameOver();
            });
        }

        // --- ë Œë”ë§ ë¡œì§ ---
        function renderGame() {
            const myData = gameData[myRole];
            const oppRole = (myRole === 'host') ? 'guest' : 'host';
            const oppData = gameData[oppRole];
            const isMyTurn = (gameData.turn === myRole);

            // 1. í„´ í‘œì‹œ
            const ind = document.getElementById('turn-indicator');
            ind.innerText = isMyTurn ? `ğŸ“¢ ë‹¹ì‹ ì˜ í„´ì…ë‹ˆë‹¤! (AP: ${myData.ap})` : `â³ ìƒëŒ€ë°©(${oppRole})ì˜ í„´ì…ë‹ˆë‹¤...`;
            ind.className = isMyTurn ? 'active-turn-indicator turn-my' : 'active-turn-indicator turn-opp';
            document.getElementById('my-area').classList.toggle('active-turn', isMyTurn);

            // 2. ë‰´ìŠ¤
            const evt = gameData.currentEvent;
            document.getElementById('active-news-ticker').innerHTML = `ğŸ“° ì˜¤ëŠ˜ì˜ ë‰´ìŠ¤: <b>${evt.name}</b> (${evt.desc})`;

            // 3. ë‚´ ìƒíƒœ
            document.getElementById('my-city').innerHTML = `${myData.city.name} <span class="weakness">(${myData.city.weakText})</span>`;
            document.getElementById('my-ap').innerText = myData.ap;
            document.getElementById('my-damage').innerText = myData.hp;
            document.getElementById('my-money').innerText = myData.money;
            
            // 4. ìƒëŒ€ ìƒíƒœ
            document.getElementById('opp-city').innerHTML = `${oppData.city.name} <span class="weakness">(${oppData.city.weakText})</span>`;
            document.getElementById('opp-damage').innerText = oppData.hp;
            document.getElementById('opp-money').innerText = oppData.money;

            // 5. ì¹´ë“œ ë Œë”ë§
            renderHand(document.getElementById('my-hand'), myData.hand || [], false);
            renderHand(document.getElementById('opp-hand'), oppData.hand || [], true);
            renderField(document.getElementById('my-field'), myData.field || []);
            renderField(document.getElementById('opp-field'), oppData.field || []);

            // 6. ë²„íŠ¼ ìƒíƒœ
            document.getElementById('play-btn').disabled = !isMyTurn || myData.ap < 1;
            document.getElementById('draw-btn').disabled = !isMyTurn || myData.ap < 1;
            document.getElementById('end-btn').disabled = !isMyTurn;

            // 7. ë¡œê·¸
            const logBox = document.getElementById('message-log');
            if(logBox.lastChild?.innerText !== gameData.log) {
                const p = document.createElement('div');
                p.innerHTML = `[Turn ${gameData.turnCount}] ${gameData.log}`;
                p.style.borderBottom = "1px solid #eee"; p.style.padding = "4px";
                logBox.appendChild(p);
                logBox.scrollTop = logBox.scrollHeight;
            }
        }

        function renderHand(container, cards, isOpponent) {
            container.innerHTML = "";
            cards.forEach(card => {
                const el = document.createElement('div');
                el.className = `card ${isOpponent ? 'hidden' : 'type-'+(card.type==='disaster'?'disaster':card.type)}`;
                
                if(!isOpponent) {
                    el.innerHTML = `<div style="font-weight:bold">${card.name}</div>`;
                    if(card.type === 'disaster') el.innerHTML += `<div style="color:#d32f2f">í”¼í•´: ${card.dmg}</div><div style="font-size:0.8em">${card.dType}</div>`;
                    else el.innerHTML += `<div style="color:#007bff">ë¹„ìš©: ${card.cost}</div><div>ë°©ì–´: ${card.power}</div>`;
                    
                    if(selectedCardIds.includes(card.id)) el.classList.add('selected');
                    el.onclick = () => toggleSelect(card.id);
                }
                container.appendChild(el);
            });
        }

        function renderField(container, cards) {
            container.innerHTML = "";
            cards.forEach(card => {
                const el = document.createElement('div');
                el.className = `card type-${card.type}`;
                el.innerHTML = `<div style="font-weight:bold">${card.name}</div><div style="font-size:0.8em">ì„¤ì¹˜ë¨</div>`;
                container.appendChild(el);
            });
        }

        function toggleSelect(id) {
            if(gameData.turn !== myRole) return;
            if(selectedCardIds.includes(id)) selectedCardIds = selectedCardIds.filter(x => x !== id);
            else selectedCardIds.push(id);
            renderGame();
        }

        // --- ì•¡ì…˜ ë¡œì§ ---

        // 1. ì¹´ë“œ ë½‘ê¸°
        document.getElementById('draw-btn').addEventListener('click', async () => {
            const updates = {};
            const deck = [...(gameData.deck || [])];
            if(deck.length === 0) return alert("ë±ì´ ë¹„ì—ˆìŠµë‹ˆë‹¤!");
            
            const card = deck.pop();
            const myHand = [...(gameData[myRole].hand || [])];
            myHand.push(card);

            updates[`rooms/${roomId}/deck`] = deck;
            updates[`rooms/${roomId}/${myRole}/hand`] = myHand;
            updates[`rooms/${roomId}/${myRole}/ap`] = gameData[myRole].ap - 1;
            updates[`rooms/${roomId}/log`] = `${myRole}ê°€ ì¹´ë“œë¥¼ 1ì¥ ë½‘ì•˜ìŠµë‹ˆë‹¤.`;

            await update(ref(db), updates);
        });

        // 2. ì¹´ë“œ ì‚¬ìš© (í•µì‹¬)
        document.getElementById('play-btn').addEventListener('click', async () => {
            if(selectedCardIds.length === 0) return alert("ì‚¬ìš©í•  ì¹´ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”.");
            
            const myData = gameData[myRole];
            const myHand = myData.hand || [];
            const selectedCards = myHand.filter(c => selectedCardIds.includes(c.id));
            
            if(myData.ap < selectedCards.length) return alert("APê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.");

            // ë¹„ìš© ê³„ì‚° (ì¬ë‚œ ì œì™¸)
            let totalCost = 0;
            const evt = gameData.currentEvent;
            
            const mitigations = selectedCards.filter(c => c.type !== 'disaster');
            const disasters = selectedCards.filter(c => c.type === 'disaster');

            mitigations.forEach(c => {
                let cost = c.cost;
                if(evt.type === 'cost_up') cost += evt.val;
                if(evt.type === 'cost_down') cost = Math.max(0, cost - evt.val);
                totalCost += cost;
            });

            if(myData.money < totalCost) return alert("ì˜ˆì‚°ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.");

            // DB ì—…ë°ì´íŠ¸ ì¤€ë¹„
            const updates = {};
            const oppRole = (myRole === 'host') ? 'guest' : 'host';
            let oppHp = gameData[oppRole].hp;
            let logMsg = "";

            // ë°©ì¬ ì¹´ë“œ ì„¤ì¹˜
            if(mitigations.length > 0) {
                const newField = [...(myData.field || []), ...mitigations];
                updates[`rooms/${roomId}/${myRole}/field`] = newField;
                logMsg += `${myRole}ê°€ ë°©ì¬ì‹œì„¤ ${mitigations.length}ê°œë¥¼ ì„¤ì¹˜í–ˆìŠµë‹ˆë‹¤. `;
            }

            // ì¬ë‚œ ì¹´ë“œ ê³µê²©
            if(disasters.length > 0) {
                const oppField = gameData[oppRole].field || [];
                let totalDmg = 0;

                disasters.forEach(d => {
                    let dmg = d.dmg;
                    // ì´ë²¤íŠ¸ ë²„í”„
                    if(evt.type === 'attack_buff') dmg = Math.floor(dmg * evt.val);
                    // ìƒì„± (ì•½ì )
                    if(d.dType === gameData[oppRole].city.weakType) dmg = Math.floor(dmg * 1.5);
                    
                    // ë°©ì–´ ê³„ì‚°
                    let mitigationPower = 0;
                    // ë²”ìš© ë°©ì–´
                    oppField.filter(f => f.type === 'general').forEach(f => mitigationPower += f.power);
                    // íŠ¹ì • ë°©ì–´ (ì½¤ë³´ ê³„ì‚° ìƒëµ - ë³µì¡ë„ ì¤„ì„, ë‹¨ìˆœ í•©ì‚°)
                    oppField.filter(f => f.subType === 'specific' && f.target === d.name).forEach(f => mitigationPower += f.power);

                    const finalDmg = Math.max(0, dmg - mitigationPower);
                    totalDmg += finalDmg;
                });
                
                oppHp += totalDmg;
                updates[`rooms/${roomId}/${oppRole}/hp`] = oppHp;
                logMsg += `${myRole}ê°€ ì¬ë‚œìœ¼ë¡œ ${totalDmg}ì˜ í”¼í•´ë¥¼ ì…í˜”ìŠµë‹ˆë‹¤! `;
            }

            // ìì› ì°¨ê° ë° í•¸ë“œ ì •ë¦¬
            const remainingHand = myHand.filter(c => !selectedCardIds.includes(c.id));
            updates[`rooms/${roomId}/${myRole}/hand`] = remainingHand;
            updates[`rooms/${roomId}/${myRole}/money`] = myData.money - totalCost;
            updates[`rooms/${roomId}/${myRole}/ap`] = myData.ap - selectedCards.length;
            updates[`rooms/${roomId}/log`] = logMsg;

            await update(ref(db), updates);
            selectedCardIds = []; // ì„ íƒ ì´ˆê¸°í™”
        });

        // 3. í„´ ì¢…ë£Œ
        document.getElementById('end-btn').addEventListener('click', async () => {
            const updates = {};
            const nextTurn = (myRole === 'host') ? 'guest' : 'host';
            const nextEvent = EVENTS[Math.floor(Math.random() * EVENTS.length)];
            
            // í„´ ë„˜ê¸°ë©´ì„œ ë‹¤ìŒ ì‚¬ëŒ AP íšŒë³µ, ëˆ ì§€ê¸‰
            const nextData = gameData[nextTurn];
            updates[`rooms/${roomId}/${nextTurn}/ap`] = 2;
            updates[`rooms/${roomId}/${nextTurn}/money`] = nextData.money + 100;
            
            updates[`rooms/${roomId}/turn`] = nextTurn;
            updates[`rooms/${roomId}/turnCount`] = gameData.turnCount + 1;
            updates[`rooms/${roomId}/currentEvent`] = nextEvent;
            updates[`rooms/${roomId}/log`] = `--- í„´ ì¢…ë£Œ! ${nextTurn}ì˜ ì°¨ë¡€ (ë‰´ìŠ¤: ${nextEvent.name}) ---`;

            await update(ref(db), updates);
        });

        // --- ê²Œì„ ì¢…ë£Œ í™•ì¸ ---
        function checkGameOver() {
            if(gameData.status === 'ended') return;

            const hostDmg = gameData.host.hp;
            const guestDmg = gameData.guest.hp;
            let winner = null;
            let reason = "";

            if(hostDmg >= 2000) { winner = "Guest"; reason = "Host ë„ì‹œ íŒŒì‚°"; }
            else if(guestDmg >= 2000) { winner = "Host"; reason = "Guest ë„ì‹œ íŒŒì‚°"; }
            else if(gameData.turnCount > 20) {
                if(hostDmg < guestDmg) { winner = "Host"; reason = "í„´ ì¢…ë£Œ (í”¼í•´ëŸ‰ ìŠ¹)"; }
                else if(guestDmg < hostDmg) { winner = "Guest"; reason = "í„´ ì¢…ë£Œ (í”¼í•´ëŸ‰ ìŠ¹)"; }
                else { winner = "Draw"; reason = "ë¬´ìŠ¹ë¶€"; }
            }

            if(winner) {
                document.getElementById('result-modal').style.display = 'flex';
                document.getElementById('result-title').innerText = winner === 'Draw' ? "ë¬´ìŠ¹ë¶€" : `${winner} ìŠ¹ë¦¬!`;
                document.getElementById('result-desc').innerText = reason;
                // DBì— ì¢…ë£Œ ìƒíƒœ ê¸°ë¡ (ë¬´í•œë£¨í”„ ë°©ì§€)
                if(myRole === 'host') update(ref(db, `rooms/${roomId}`), { status: 'ended' });
            }
        }
    </script>
</body>
</html>



