<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¬ë‚œ ê´€ë¦¬ ì¹´ë“œ ê²Œì„ (Online Final Production)</title>
    <style>
        /* CSS ìŠ¤íƒ€ì¼ì€ ìµœì¢… ì˜¤í”„ë¼ì¸ ë²„ì „ì„ ê¸°ë°˜ìœ¼ë¡œ ìœ ì§€ë©ë‹ˆë‹¤. */
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background-color: #f0f2f5; margin: 0; padding: 0; }
        
        /* 0. ì¸íŠ¸ë¡œ í™”ë©´ (ì¶”ê°€ë¨) */
        #intro-screen {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white; z-index: 5000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .intro-box {
            background-color: rgba(255, 255, 255, 0.95); color: #333;
            padding: 40px; border-radius: 20px; text-align: center;
            width: 90%; max-width: 500px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .intro-input { width: 80%; padding: 15px; font-size: 1.2em; margin: 10px 0; border: 2px solid #ddd; border-radius: 8px; text-align: center; }
        .intro-btn { width: 90%; padding: 15px; font-size: 1.2em; margin: 5px 0; border: none; border-radius: 50px; cursor: pointer; font-weight: bold; color: white; transition: 0.2s; }
        #create-btn { background-color: #28a745; }
        #join-btn { background-color: #007bff; }
        .intro-btn:hover { transform: scale(1.05); filter: brightness(1.1); }
        
        /* 1. í„´ ëŒ€ê¸° ì˜¤ë²„ë ˆì´ */
        #turn-overlay {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background-color: rgba(0, 0, 0, 0.95); color: white; z-index: 2000;
            display: none; 
            flex-direction: column; justify-content: center; align-items: center; text-align: center;
        }
        #turn-overlay h1 { font-size: 3em; margin-bottom: 20px; }
        #turn-overlay p { font-size: 1.5em; margin-bottom: 40px; color: #ccc; }
        #start-turn-btn { font-size: 1.5em; padding: 15px 40px; cursor: pointer; background-color: #007bff; color: white; border: none; border-radius: 8px; transition: transform 0.2s; }
        #start-turn-btn:hover { transform: scale(1.05); background-color: #0056b3; }

        /* ê²°ê³¼ ìš”ì•½ í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        .summary-box { background: rgba(255, 255, 255, 0.1); padding: 20px; border-radius: 15px; margin-bottom: 30px; min-width: 300px; text-align: left; }
        .summary-table { width: 100%; border-collapse: collapse; color: white; font-size: 1.1em; }
        .summary-table th, .summary-table td { padding: 10px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.2); }
        .summary-table th { color: #aaa; font-weight: normal; font-size: 0.9em; }
        .summary-table td:first-child { text-align: left; font-weight: bold; color: #ddd; }
        .val-bad { color: #ff6b6b; font-weight: bold; }
        .val-good { color: #51cf66; font-weight: bold; }

        /* 2. ë‰´ìŠ¤ ì†ë³´ ëª¨ë‹¬ (ìˆ˜ì •ë¨: íŒì—… ì—­í• ) */
        #news-modal {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background-color: rgba(0, 0, 0, 0.85); z-index: 6000; /* Z-index ë†’ì„ */
            display: none; justify-content: center; align-items: center;
        }
        .news-content {
            background-color: white; width: 90%; max-width: 600px; padding: 40px; border-radius: 15px; text-align: center; box-shadow: 0 0 50px rgba(255, 255, 255, 0.3); 
            animation: popUp 0.3s ease-out;
        }
        @keyframes popUp { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .news-badge { display: inline-block; padding: 8px 20px; border-radius: 25px; font-weight: bold; color: white; margin-bottom: 20px; font-size: 1.2em; }
        .bg-bad { background-color: #dc3545; }
        .bg-good { background-color: #28a745; }
        .bg-normal { background-color: #6c757d; }
        .news-title { font-size: 2.5em; font-weight: bold; margin-bottom: 20px; color: #333; }
        .news-desc { font-size: 1.4em; color: #555; margin-bottom: 40px; line-height: 1.6; }
        #confirm-news-btn { font-size: 1.3em; padding: 15px 40px; cursor: pointer; background-color: #333; color: white; border: none; border-radius: 8px; font-weight: bold; }

        /* 3. ê²Œì„ ë©”ì¸ í™”ë©´ */
        #game-container { display: none; max-width: 1000px; margin: 20px auto; background-color: #f0f2f5; padding: 20px; border-radius: 15px; }
        .active-turn-indicator { position: fixed; top: 0; left: 0; width: 100%; padding: 10px; text-align: center; color: white; font-weight: bold; font-size: 1.2em; z-index: 1000; display:none; }

        .player-area { border: 2px solid #ccc; border-radius: 10px; padding: 20px; margin-bottom: 20px; background-color: #ffffff; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .player-area.active-turn { border: 4px solid #007bff; box-shadow: 0 0 20px rgba(0,123,255,0.3); }
        
        .status-bar { display: flex; justify-content: space-between; align-items: center; padding-bottom: 15px; border-bottom: 1px solid #eee; margin-bottom: 15px; }
        .city-badge { font-size: 0.8em; background-color: #495057; color: white; padding: 5px 10px; border-radius: 15px; margin-left: 10px; }
        .weakness-highlight { color: #ff6b6b; font-weight: bold; margin-left: 5px; }
        .player-stats { display: flex; gap: 15px; text-align: right; }
        .stat-box { font-size: 1.1em; font-weight: 700; background-color: #f8f9fa; padding: 8px 12px; border-radius: 6px; display: flex; align-items: center; gap: 5px; }

        .card-container { display: flex; flex-wrap: wrap; gap: 10px; min-height: 120px; background-color: #f8f9fa; border-radius: 8px; padding: 15px; }
        .card { width: 110px; height: 160px; background-color: #fff; border: 2px solid #ddd; border-radius: 8px; padding: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); cursor: pointer; transition: transform 0.1s ease; display: flex; flex-direction: column; justify-content: space-between; font-size: 0.9em; user-select: none; }
        .card.selected { border: 3px solid #007bff !important; background-color: #e3f2fd !important; transform: scale(1.05); box-shadow: 0 0 15px rgba(0,123,255,0.4) !important; }
        
        .card.hidden { background: #555; border: 2px solid #444; justify-content: center; align-items: center; }
        .card.hidden::after { content: "CARD"; color: #888; font-weight: bold; }
        .card.hidden * { display: none; }

        #controls { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px; margin-top: 20px; }
        .control-btn { padding: 15px; font-size: 1em; font-weight: 600; cursor: pointer; border: none; border-radius: 8px; color: white; transition: filter 0.2s; }
        .control-btn:disabled { background-color: #ccc !important; cursor: not-allowed; filter: none; }
        #play-btn { background-color: #28a745; grid-column: span 2; }
        #draw-btn { background-color: #007bff; }
        #recover-btn { background-color: #ffc107; color: #212529; }
        #end-btn { background-color: #dc3545; grid-column: span 4; margin-top: 10px; }

        #message-log { margin-top: 20px; background-color: #fff; border: 1px solid #ddd; border-radius: 8px; padding: 15px; height: 150px; overflow-y: auto; font-size: 0.9em; }
    </style>
</head>
<body>

    <div id="intro-screen">
        <div class="intro-box">
            <h1>ğŸŒªï¸ ì¬ë‚œ ì¹´ë“œ ê²Œì„ Online</h1>
            <p>ë°© ì´ë¦„ì„ ì…ë ¥í•˜ì—¬ ì¹œêµ¬ì™€ ì—°ê²°í•˜ì„¸ìš”.</p>
            <input type="text" id="room-input" class="intro-input" placeholder="ë°© ì´ë¦„ (ì˜ˆ: myroom)">
            <button id="create-btn" class="intro-btn">ë°© ë§Œë“¤ê¸° (Host)</button>
            <button id="join-btn" class="intro-btn">ë°© ì°¸ê°€í•˜ê¸° (Guest)</button>
            <p style="font-size:0.8em; color:#666; margin-top:20px;">*ê°™ì€ ë°© ì´ë¦„ì„ ì…ë ¥í•´ì•¼ ë§Œë‚  ìˆ˜ ìˆìŠµë‹ˆë‹¤. Hostê°€ ê²Œì„ì„ ì‹œì‘í•´ì•¼ Guestê°€ ì ‘ì†ë©ë‹ˆë‹¤.</p>
        </div>
    </div>

    <div id="turn-indicator" class="active-turn-indicator">ê²Œì„ ëŒ€ê¸° ì¤‘...</div>

    <div id="news-modal">
        <div class="news-content">
            <div id="news-badge" class="news-badge bg-normal">ì¼ì¼ ì¬ë‚œ ë¸Œë¦¬í•‘</div>
            <div id="news-title" class="news-title">ë‰´ìŠ¤ ì œëª©</div>
            <div id="news-desc" class="news-desc">ë‰´ìŠ¤ ë‚´ìš©</div>
            <button id="confirm-news-btn">í™•ì¸ (ì‘ì „ ê°œì‹œ)</button>
        </div>
    </div>

    <div id="game-container">
        
        <div id="active-news-ticker">ğŸ“° ë‰´ìŠ¤: ê²Œì„ ì‹œì‘ ëŒ€ê¸° ì¤‘...</div>

        <div id="opponent-area" class="player-area">
            <div class="status-bar">
                <div>
                    <span style="font-size:1.5em; font-weight:bold;">ğŸ‘¤ ìƒëŒ€ë°©</span>
                    <span id="opp-city-badge" class="city-badge">ë„ì‹œ ì •ë³´</span>
                </div>
                <div class="player-stats">
                    <div class="stat-box ap" style="opacity:0.5">AP: ?</div>
                    <div class="stat-box damage">ğŸ’” í”¼í•´: <span id="opponent-damage-val">0</span></div>
                    <div class="stat-box currency">ğŸ’° ì˜ˆì‚°: <span id="opponent-currency-val">0</span></div>
                </div>
            </div>
            <div class="area-title">ìƒëŒ€ ë„ì‹œ ì‹œì„¤ (ì •ë³´ ì œí•œë¨)</div>
            <div id="opp-field" class="card-container"></div>
            <div class="area-title">ìƒëŒ€ ì†íŒ¨</div>
            <div id="opp-hand" class="card-container" style="background:#e9ecef;"></div>
        </div>

        <div id="my-area" class="player-area">
            <div class="status-bar">
                <div>
                    <span style="font-size:1.5em; font-weight:bold; color:#007bff;">ME ë‚˜</span>
                    <span id="my-city-badge" class="city-badge">ë„ì‹œ ì •ë³´</span>
                </div>
                <div class="player-stats">
                    <div class="stat-box ap">âš¡ AP: <span id="my-ap-val">0</span></div>
                    <div class="stat-box damage">ğŸ’” í”¼í•´: <span id="my-damage-val">0</span></div>
                    <div class="stat-box currency">ğŸ’° ì˜ˆì‚°: <span id="my-currency-val">0</span></div>
                </div>
            </div>
            <div class="area-title">ë‚´ ì„¤ì¹˜ ì‹œì„¤</div>
            <div id="my-field" class="card-container"></div>
            <div class="area-title">ë‚´ ì†íŒ¨ (í´ë¦­í•˜ì—¬ ì„ íƒ)</div>
            <div id="my-hand" class="card-container"></div>
        </div>

        <div id="controls">
            <button id="play-btn" class="control-btn" disabled>ì¹´ë“œ ì‚¬ìš© (0 AP)</button>
            <button id="draw-btn" class="control-btn" disabled>ì¹´ë“œ ë½‘ê¸° (1 AP)</button>
            <button id="recover-btn" class="control-btn" disabled>í”¼í•´ ë³µêµ¬ (1 AP)</button>
            <button id="end-btn" class="control-btn" disabled>í„´ ì¢…ë£Œ</button>
        </div>

        <div id="message-log"></div>
    </div>

    <div id="result-modal" style="display:none;">
        <div class="result-box">
            <h1 id="result-title" style="color:gold;">ê²Œì„ ì¢…ë£Œ</h1>
            <p id="result-desc"></p>
            <button onclick="location.reload()" style="padding:10px 30px; margin-top:20px; cursor:pointer;">ë¡œë¹„ë¡œ ëŒì•„ê°€ê¸°</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, update, get } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // ============================================================
        // ğŸ”¥ [ì¤‘ìš”] ì—¬ê¸°ì— Firebase ì„¤ì •ê°’ì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš” ğŸ”¥
        // ============================================================
        const firebaseConfig = {
          apiKey: "AIzaSyBmAUvLNMXYGS5674lob7kZzzkLH4ctYBU",
          authDomain: "disaster-game-online.firebaseapp.com",
          projectId: "disaster-game-online",
          storageBucket: "disaster-game-online.firebasestorage.app",
          messagingSenderId: "557399169778",
          appId: "1:557399169778:web:809b8f4444cbbc6b14ce6b",
          databaseURL: "https://disaster-game-online-default-rtdb.firebaseio.com",
          measurementId: "G-PCF2JDM9HF"
        };
        // ============================================================

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- ìƒìˆ˜ ë° í´ë˜ìŠ¤ ì •ì˜ (ì˜¤í”„ë¼ì¸ ìµœì¢…ë³¸ ì´ì‹) ---
        const DisasterType = { WINTER: "ê²¨ìš¸ì²  ì¬ë‚œ", WIND_FLOOD: "í’ìˆ˜í•´", MOUNTAIN: "ì‚°ì•… ì¬ë‚œ" };
        const MitigationPhase = { PREVENTION: "ì˜ˆë°©", PREPAREDNESS: "ì¤€ë¹„", GENERAL: "ë²”ìš©" };
        
        const CITY_TYPES = [
            { name: "ğŸŒŠ í•´ì•ˆ ë„ì‹œ", weakType: DisasterType.WIND_FLOOD, weakText: "í’ìˆ˜í•´ ì·¨ì•½", maxHp: 2000 },
            { name: "ğŸšï¸ ë…¸í›„ ë„ì‹¬", weakType: DisasterType.WINTER, weakText: "ê²¨ìš¸ì²  ì·¨ì•½", maxHp: 2000 },
            { name: "â›°ï¸ ì‚°ê°„ ì§€ì—­", weakType: DisasterType.MOUNTAIN, weakText: "ì‚°ì•… ì·¨ì•½", maxHp: 2000 }
        ];

        const EVENTS = [
            { id: 'normal', name: "â˜€ï¸ í‰ì˜¨í•œ ë‚ ", desc: "íŠ¹ì´ ì‚¬í•­ ì—†ìŒ", type: "normal", val: 0, badge: "í‰ì˜¨", bg: "bg-normal" },
            { id: 'climate', name: "âš ï¸ ê¸°í›„ ì´ìƒ", desc: "ì¬ë‚œ ê³µê²©ë ¥ 1.5ë°°", type: "attack_buff", val: 1.5, badge: "ìœ„ê¸°", bg: "bg-bad" },
            { id: 'inflation', name: "ğŸ’¸ ë¬¼ê°€ ìƒìŠ¹", desc: "ì‹œì„¤ ë¹„ìš© +50", type: "cost_up", val: 50, badge: "ìœ„ê¸°", bg: "bg-bad" },
            { id: 'delay', name: "ğŸ“‰ ë³µêµ¬ ì§€ì—°", desc: "ë³µêµ¬ ë¹„ìš© 3ë°°", type: "recover_nerf", val: 3, badge: "ìœ„ê¸°", bg: "bg-bad" },
            { id: 'tech', name: "ğŸ’¡ ê¸°ìˆ  í˜ì‹ ", desc: "ì‹œì„¤ ë¹„ìš© -50", type: "cost_down", val: 50, badge: "ê¸°íšŒ", bg: "bg-good" },
            { id: 'gov', name: "ğŸ¤ ë¯¼ê´€ í˜‘ë ¥", desc: "ë³µêµ¬ ë¹„ìš© 1.5ë°° ê°ì†Œ", type: "recover_buff", val: 1.5, badge: "ê¸°íšŒ", bg: "bg-good" }
        ];
        
        // ì˜¤í”„ë¼ì¸ í´ë˜ìŠ¤ ì •ì˜ (ë°ì´í„° ìƒì„±ìš©)
        class Card {
            constructor(name) { this.name = name; this.id = 'card_' + Date.now() + '_' + Math.floor(Math.random() * 99999); }
        }
        class DisasterCard extends Card {
            constructor(name, disasterType, baseDamage) {
                super(name); this.disasterType = disasterType; this.baseDamage = baseDamage; this.cardType = "disaster";
            }
        }
        class MitigationCard extends Card {
            constructor(name, cost, power, mitigationType, phase = null, disasterTarget = null) {
                super(name); this.cost = cost; this.power = power; this.mitigationType = mitigationType;
                this.phase = phase; this.disasterTarget = disasterTarget;
                this.cardType = (mitigationType === 'general') ? 'general' : 'mitigation';
            }
        }

        // ì˜¤í”„ë¼ì¸ ìµœì¢…ë³¸ì˜ Card Data
        const DISASTER_DATA_CLASS = [
            new DisasterCard("ëŒ€ì„¤ (50)", DisasterType.WINTER, 50), new DisasterCard("ëŒ€ì„¤ (100)", DisasterType.WINTER, 100), new DisasterCard("ëŒ€ì„¤ (200)", DisasterType.WINTER, 200),
            new DisasterCard("í•œíŒŒ (50)", DisasterType.WINTER, 50), new DisasterCard("í•œíŒŒ (100)", DisasterType.WINTER, 100), new DisasterCard("í•œíŒŒ (200)", DisasterType.WINTER, 200),
            new DisasterCard("í­ìš° (50)", DisasterType.WIND_FLOOD, 50), new DisasterCard("í­ìš° (100)", DisasterType.WIND_FLOOD, 100), new DisasterCard("í­ìš° (200)", DisasterType.WIND_FLOOD, 200),
            new DisasterCard("íƒœí’ (50)", DisasterType.WIND_FLOOD, 50), new DisasterCard("íƒœí’ (100)", DisasterType.WIND_FLOOD, 100), new DisasterCard("íƒœí’ (200)", DisasterType.WIND_FLOOD, 200),
            new DisasterCard("ì‚°ë¶ˆ (50)", DisasterType.MOUNTAIN, 50), new DisasterCard("ì‚°ë¶ˆ (100)", DisasterType.MOUNTAIN, 100), new DisasterCard("ì‚°ë¶ˆ (200)", DisasterType.MOUNTAIN, 200),
            new DisasterCard("ì‚°ì‚¬íƒœ (50)", DisasterType.MOUNTAIN, 50), new DisasterCard("ì‚°ì‚¬íƒœ (100)", DisasterType.MOUNTAIN, 100), new DisasterCard("ì‚°ì‚¬íƒœ (200)", DisasterType.MOUNTAIN, 200),
        ];
        
        const SPECIFIC_MITIGATION_DATA_CLASS = [
            new MitigationCard("ë„ë¡œ ì—´ì„  ì¼€ì´ë¸” ì„¤ì¹˜", 200, 150, 'specific', MitigationPhase.PREVENTION, "ëŒ€ì„¤"),
            new MitigationCard("ë…¸í›„ ì‹œì„¤ë¬¼ ì§€ë¶• ë³´ê°•", 300, 250, 'specific', MitigationPhase.PREVENTION, "ëŒ€ì„¤"),
            new MitigationCard("ì œì„¤ ì¥ë¹„ í™•ë³´ ë° ìœ ì§€", 50, 30, 'specific', MitigationPhase.PREPAREDNESS, "ëŒ€ì„¤"),
            new MitigationCard("ì œì„¤ì œ ë¹„ì¶•", 100, 70, 'specific', MitigationPhase.PREPAREDNESS, "ëŒ€ì„¤"),

            new MitigationCard("ì·¨ì•½ ì‹œì„¤ ë‹¨ì—´ ë³´ê°•", 200, 150, 'specific', MitigationPhase.PREVENTION, "í•œíŒŒ"),
            new MitigationCard("ë„ì‹œ ê°€ìŠ¤ê´€ ì•ˆì „ ì ê²€", 300, 250, 'specific', MitigationPhase.PREVENTION, "í•œíŒŒ"),
            new MitigationCard("ë‚œë°©ìš©í’ˆ ì§€ì› ë° ì—°ë½ë§ êµ¬ì¶•", 50, 30, 'specific', MitigationPhase.PREPAREDNESS, "í•œíŒŒ"),
            new MitigationCard("ìˆ˜ë„ê´€ ë™íŒŒ ë°©ì§€ í‚¤íŠ¸ ë°°í¬", 100, 70, 'specific', MitigationPhase.PREPAREDNESS, "í•œíŒŒ"),

            new MitigationCard("í•˜ì²œ ì œë°©/ëŒ ë³´ê°•", 200, 150, 'specific', MitigationPhase.PREVENTION, "í­ìš°"),
            new MitigationCard("ë„ì‹œ ë°°ìˆ˜ ìš©ëŸ‰ í™•ëŒ€", 300, 250, 'specific', MitigationPhase.PREVENTION, "í­ìš°"),
            new MitigationCard("ì¬ë‚œ ê²½ë³´/í™ìˆ˜ í†µì œ ì‹œìŠ¤í…œ", 50, 30, 'specific', MitigationPhase.PREPAREDNESS, "í­ìš°"),
            new MitigationCard("ì¹¨ìˆ˜ ì·¨ì•½ì§€ ëª¨ë˜ì£¼ë¨¸ë‹ˆ ë¹„ì¶•", 100, 70, 'specific', MitigationPhase.PREPAREDNESS, "í­ìš°"),

            new MitigationCard("í•´ì•ˆ ë°©íŒŒì œ/ë°©ì¡°ì œ ë³´ê°•", 200, 150, 'specific', MitigationPhase.PREVENTION, "íƒœí’"),
            new MitigationCard("ì „ë ¥/í†µì‹  ì‹œì„¤ ì§€ë°˜ ê³ ì •", 300, 250, 'specific', MitigationPhase.PREVENTION, "íƒœí’"),
            new MitigationCard("ì°½ë¬¸/ë¬¸ ì•ˆì „ ë³´ê°• ì •ì±…", 50, 30, 'specific', MitigationPhase.PREPAREDNESS, "íƒœí’"),
            new MitigationCard("ì–´ì„ /ì„ ë°• ê²°ë°• ë° í”¼í•­ ì¡°ì¹˜", 100, 70, 'specific', MitigationPhase.PREPAREDNESS, "íƒœí’"),

            new MitigationCard("ì‚°ë¶ˆ ì €ì§€ ë°©í™”ì„  êµ¬ì¶•", 200, 150, 'specific', MitigationPhase.PREVENTION, "ì‚°ë¶ˆ"),
            new MitigationCard("ì‚°ë¶ˆ ê°ì‹œ CCTV/íƒ‘ ì„¤ì¹˜", 300, 250, 'specific', MitigationPhase.PREVENTION, "ì‚°ë¶ˆ"),
            new MitigationCard("ë“±ì‚°ë¡œ ì…ì‚° í†µì œ", 50, 30, 'specific', MitigationPhase.PREPAREDNESS, "ì‚°ë¶ˆ"),
            new MitigationCard("ì§„í™” í—¬ê¸°/ì°¨ëŸ‰ ë°°ì¹˜", 100, 70, 'specific', MitigationPhase.PREPAREDNESS, "ì‚°ë¶ˆ"),

            new MitigationCard("ì‚¬ë°©ëŒ ë° ì˜¹ë²½ ê±´ì„¤", 200, 150, 'specific', MitigationPhase.PREVENTION, "ì‚°ì‚¬íƒœ"),
            new MitigationCard("ê¸‰ê²½ì‚¬ì§€ ì‚¬ë©´ ë³´ê°•", 300, 250, 'specific', MitigationPhase.PREVENTION, "ì‚°ì‚¬íƒœ"),
            new MitigationCard("ì‚°ì‚¬íƒœ ì˜ˆë³´ ì‹œìŠ¤í…œ ê°€ë™", 50, 30, 'specific', MitigationPhase.PREPAREDNESS, "ì‚°ì‚¬íƒœ"),
            new MitigationCard("ì£¼ë¯¼ ëŒ€í”¼ì†Œ ì§€ì • ë° ì•ˆë‚´", 100, 70, 'specific', MitigationPhase.PREPAREDNESS, "ì‚°ì‚¬íƒœ"),
        ];

        const GENERAL_MITIGATION_DATA_CLASS = [
            new MitigationCard(`ì¬ë‚œ ê´€ë¦¬ ì‹œìŠ¤í…œ í†µí•©`, 150, 80, 'general', MitigationPhase.GENERAL, null),
            new MitigationCard(`ì‹œë¯¼ ì•ˆì „ êµìœ¡ í™•ëŒ€`, 100, 50, 'general', MitigationPhase.GENERAL, null),
            new MitigationCard(`ì¬ë‚œ ëŒ€ì‘ ë§¤ë‰´ì–¼ ë°°í¬`, 120, 60, 'general', MitigationPhase.GENERAL, null)
        ];
        // --- ìƒìˆ˜ ë° í´ë˜ìŠ¤ ì •ì˜ ë ---


        // --- ì „ì—­ ë³€ìˆ˜ ---
        let roomId = "";
        let myRole = ""; // 'host' or 'guest'
        let gameData = null;
        let selectedCardIds = [];

        // --- ì¹´ë“œ ìƒì„± ë° ë± ë¹Œë“œ í•¨ìˆ˜ ---
        function createDeck() {
            let cards = [];
            const add = (c) => {
                // í´ë˜ìŠ¤ ì¸ìŠ¤í„´ìŠ¤ì˜ ì†ì„±ì„ JSON ê°ì²´ë¡œ ë³€í™˜í•˜ì—¬ ì €ì¥
                if (c.cardType === 'disaster') {
                    cards.push({
                        name: c.name, type: c.cardType, dType: c.disasterType, dmg: c.baseDamage, 
                        id: `c_${Date.now()}_${Math.random().toString(36).substr(2,9)}`
                    });
                } else { // mitigation or general
                    cards.push({
                        name: c.name, type: c.cardType, subType: c.mitigationType, target: c.disasterTarget,
                        phase: c.phase, cost: c.cost, power: c.power,
                        id: `m_${Date.now()}_${Math.random().toString(36).substr(2,9)}`
                    });
                }
            };
            
            // ì¬ë‚œ 4ì„¸íŠ¸
            DISASTER_DATA_CLASS.forEach(d => add(d));
            DISASTER_DATA_CLASS.forEach(d => add(d));
            DISASTER_DATA_CLASS.forEach(d => add(d));
            DISASTER_DATA_CLASS.forEach(d => add(d));

            // íŠ¹ì • ë°©ì¬ 3ì„¸íŠ¸
            SPECIFIC_MITIGATION_DATA_CLASS.forEach(m => add(m));
            SPECIFIC_MITIGATION_DATA_CLASS.forEach(m => add(m));
            SPECIFIC_MITIGATION_DATA_CLASS.forEach(m => add(m));
            
            // ë²”ìš© ë°©ì¬ 1ì„¸íŠ¸
            GENERAL_MITIGATION_DATA_CLASS.forEach(g => add(g));
            
            // ì…”í”Œ
            return cards.sort(() => Math.random() - 0.5);
        }
        
        // --- ì˜¤í”„ë¼ì¸ ë¡œì§ ì´ì‹: ì½¤ë³´ ë°©ì–´ë ¥ ê³„ì‚° í—¬í¼ í•¨ìˆ˜ ---
        function calculateMitigationPowerOnline(playerField, disasterCard) {
            let totalPower = 0;
            const disasterTarget = disasterCard.name.split(' ')[0]; // "ëŒ€ì„¤ (50)" -> "ëŒ€ì„¤" ì¶”ì¶œ
            
            // 1. ë²”ìš© ë°©ì–´ë ¥ (General) í•©ì‚°
            const generalCards = playerField.filter(c => c.subType === 'general');
            const numGeneral = generalCards.length;
            if (numGeneral > 0) {
                const baseGeneralPower = generalCards.reduce((sum, card) => sum + card.power, 0);
                totalPower += baseGeneralPower * numGeneral;
            }
            
            // 2. íŠ¹ì • ë°©ì–´ë ¥ (Specific) & ì½¤ë³´ ê³„ì‚°
            const specificCards = playerField.filter(
                c => c.subType === 'specific' && c.target === disasterTarget
            );
            
            if (specificCards.length > 0) {
                // ì˜¤í”„ë¼ì¸ ë¡œì§ì˜ ì½¤ë³´ ê³„ì‚° ì´ì‹
                const preventionPower = specificCards.filter(c => c.phase === MitigationPhase.PREVENTION).reduce((sum, c) => sum + c.power, 0);
                const preparednessPower = specificCards.filter(c => c.phase === MitigationPhase.PREPAREDNESS).reduce((sum, c) => sum + c.power, 0);
                const baseTotal = preventionPower + preparednessPower;
                
                if (preventionPower > 0 && preparednessPower > 0) {
                    const comboBonus = Math.max(preventionPower, preparednessPower);
                    totalPower += baseTotal + comboBonus; // ì½¤ë³´ ë°œë™
                } else {
                    totalPower += baseTotal;
                }
            }
            return totalPower;
        }

        // --- ë¡œë¹„ ë° ê²Œì„ ì´ˆê¸°í™” ë¡œì§ ---
        const introScreen = document.getElementById('intro-screen');
        const roomInput = document.getElementById('room-input');

        document.getElementById('create-btn').addEventListener('click', async () => {
            roomId = roomInput.value;
            if(!roomId) return alert("ë°© ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.");
            myRole = 'host';
            await initGame();
        });

        document.getElementById('join-btn').addEventListener('click', () => {
            roomId = roomInput.value;
            if(!roomId) return alert("ë°© ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.");
            myRole = 'guest';
            connectGame();
        });

        async function initGame() {
            try {
                // Host: ì´ˆê¸° ê²Œì„ ìƒíƒœ ìƒì„± í›„ ì—…ë¡œë“œ
                const deck = createDeck();
                const hostHand = deck.splice(0, 6);
                const guestHand = deck.splice(0, 6);
                
                const hostCity = CITY_TYPES[Math.floor(Math.random()*3)];
                const guestCity = CITY_TYPES[Math.floor(Math.random()*3)];

                const initialState = {
                    status: 'playing',
                    turn: 'host',
                    turnCount: 1,
                    currentEvent: EVENTS[0],
                    deck: deck,
                    host: {
                        name: 'Host', hp: 0, money: 1000, ap: 2,
                        city: hostCity, maxHp: hostCity.maxHp,
                        hand: hostHand, field: []
                    },
                    guest: {
                        name: 'Guest', hp: 0, money: 1200, ap: 2, 
                        city: guestCity, maxHp: guestCity.maxHp,
                        hand: guestHand, field: []
                    },
                    logHistory: ["ê²Œì„ì„ ì‹œì‘í•©ë‹ˆë‹¤. Hostì˜ í„´ì…ë‹ˆë‹¤."], // ë¡œê·¸ ë°°ì—´ ì´ˆê¸°í™”
                };

                await set(ref(db, `rooms/${roomId}`), initialState);
                connectGame();
            } catch(e) {
                alert("ê²Œì„ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. Firebase ì„¤ì •(API Key, DB URL, Rules)ì„ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.");
                console.error(e);
            }
        }

        function connectGame() {
            introScreen.style.display = 'none';
            document.getElementById('game-container').style.display = 'block';
            document.getElementById('turn-indicator').style.display = 'block';

            onValue(ref(db, `rooms/${roomId}`), (snap) => {
                gameData = snap.val();
                if(!gameData) {
                    if(myRole === 'guest') {
                        alert("ì°¸ê°€í•˜ë ¤ëŠ” ë°©ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
                        location.reload();
                        return;
                    }
                    return;
                }
                renderGame();
                checkGameOver();
            }, (error) => {
                alert("Firebase ì—°ê²° ì¤‘ ì˜¤ë¥˜ ë°œìƒ. ë°© ì´ë¦„ê³¼ ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
                console.error(error);
                location.reload();
            });
        }

        // --- ë Œë”ë§ ë° UI ë¡œì§ ---
        function renderGame() {
            const myData = gameData[myRole];
            const oppRole = (myRole === 'host') ? 'guest' : 'host';
            const oppData = gameData[oppRole];
            const isMyTurn = (gameData.turn === myRole);
            const evt = gameData.currentEvent;
            
            // 0. DOM ìš”ì†Œ ë³€ìˆ˜ ìºì‹± (Defensive Coding ì ìš©)
            const elMyAP = document.getElementById('my-ap-val');
            const elMyDmg = document.getElementById('my-damage-val');
            const elMyMoney = document.getElementById('my-currency-val');
            const elOppDmg = document.getElementById('opponent-damage-val');
            const elOppMoney = document.getElementById('opponent-currency-val');
            const elMyCity = document.getElementById('my-city-badge');
            const elOppCity = document.getElementById('opp-city-badge');
            const elLogBox = document.getElementById('message-log');
            
            // 1. í„´ í‘œì‹œ ë° UI í™œì„±í™”
            const ind = document.getElementById('turn-indicator');
            if(ind) {
                ind.innerText = isMyTurn ? `ğŸ“¢ ë‹¹ì‹ ì˜ í„´ì…ë‹ˆë‹¤! (AP: ${myData.ap})` : `â³ ìƒëŒ€ë°©(${oppRole})ì˜ í„´ì…ë‹ˆë‹¤...`;
                ind.className = isMyTurn ? 'active-turn-indicator turn-my' : 'active-turn-indicator turn-opp';
                document.getElementById('my-area').classList.toggle('active-turn', isMyTurn);
            }

            // 2. ë‰´ìŠ¤ (ëª¨ë‹¬ íŒì—… ì²˜ë¦¬ë¥¼ ìœ„í•´ JSì—ì„œ ì œì–´)
            const newsModal = document.getElementById('news-modal');
            const newsTitleEl = document.getElementById('news-title');
            const newsDescEl = document.getElementById('news-desc');
            const newsBadgeEl = document.getElementById('news-badge');
            
            // **[ìˆ˜ì • 1] ë‰´ìŠ¤ ëª¨ë‹¬ íŒì—… ì œì–´:** í„´ì´ ë°”ë€” ë•Œë§Œ ëª¨ë‹¬ íŒì—…ì„ ë„ì›ë‹ˆë‹¤.
            const isFirstLoad = gameData.turnCount === 1 && myData.ap === 2; // ì²« í„´ ì‹œì‘ ì‹œ
            if (isMyTurn && gameData.status !== 'news_shown' && newsModal) {
                 // GuestëŠ” Hostì˜ ì‹œì‘ ë²„íŠ¼ì„ ê¸°ë‹¤ë¦¼
                if (myRole === 'guest' && gameData.turnCount === 1) {
                    document.getElementById('active-news-ticker').innerHTML = `ğŸ“° ë‰´ìŠ¤: Hostê°€ í„´ì„ ì‹œì‘í•´ì•¼ í•©ë‹ˆë‹¤.`;
                    return;
                }
                
                // ëª¨ë‹¬ ë‚´ìš© ì—…ë°ì´íŠ¸
                if (newsTitleEl) newsTitleEl.innerText = evt.name;
                if (newsDescEl) newsDescEl.innerHTML = evt.desc;
                if (newsBadgeEl) {
                    newsBadgeEl.innerText = evt.badge;
                    newsBadgeEl.className = `news-badge ${evt.bg}`;
                }
                
                // ëª¨ë‹¬ ë„ìš°ê¸°
                newsModal.style.display = 'flex';
                // DBì— ëª¨ë‹¬ í‘œì‹œ ìƒíƒœë¥¼ ê¸°ë¡í•˜ì—¬ ìƒëŒ€ë°©ì—ê²ŒëŠ” íŒì—…ì´ ëœ¨ì§€ ì•Šê²Œ í•©ë‹ˆë‹¤.
                update(ref(db, `rooms/${roomId}`), { status: 'news_shown' });
            }

            // íŒì—… ë‹«íŒ í›„ ë©”ì¸ í™”ë©´ ë‰´ìŠ¤ í‹°ì»¤ ì—…ë°ì´íŠ¸
            document.getElementById('active-news-ticker').innerHTML = `ğŸ“° ì˜¤ëŠ˜ì˜ ë‰´ìŠ¤: <b class="${evt.bg ? 'bg-'+evt.bg : ''}">${evt.name}</b> (${evt.desc})`;


            // 3. ë‚´/ìƒëŒ€ ìƒíƒœ ì—…ë°ì´íŠ¸
            // **[ìˆ˜ì • 2] ìƒëŒ€ë°© ë„ì‹œ ì·¨ì•½ì  ì •ë³´ í‘œì‹œ**
            if (elMyCity) elMyCity.innerHTML = `${myData.city.name} <span class="weakness-highlight">(${myData.city.weakText})</span>`;
            if (elOppCity) elOppCity.innerHTML = `${oppData.city.name} <span class="weakness-highlight">(${oppData.city.weakText})</span>`; // ìƒëŒ€ë°© ì·¨ì•½ì  ë…¸ì¶œ
            
            if (elMyAP) elMyAP.innerText = myData.ap;
            if (elMyDmg) elMyDmg.innerText = `${myData.hp} / ${myData.maxHp}`;
            if (elMyMoney) elMyMoney.innerText = myData.money;
            
            if (elOppDmg) elOppDmg.innerText = `${oppData.hp} / ${oppData.maxHp}`;
            if (elOppMoney) elOppMoney.innerText = oppData.money;

            // 4. ì¹´ë“œ ë Œë”ë§
            renderHand(document.getElementById('my-hand'), myData.hand || [], false);
            renderHand(document.getElementById('opp-hand'), oppData.hand || [], true);
            renderField(document.getElementById('my-field'), myData.field || []);
            renderField(document.getElementById('opp-field'), oppData.field || []);

            // 5. ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
            const cardsToPlay = selectedCards();
            const hasSelected = cardsToPlay.length > 0;
            const myHp = myData.hp; 
            
            document.getElementById('play-btn').disabled = !isMyTurn || myData.ap < cardsToPlay.length || !hasSelected;
            document.getElementById('draw-btn').disabled = !isMyTurn || myData.ap < 1 || hasSelected;
            document.getElementById('recover-btn').disabled = !isMyTurn || myData.ap < 1 || myHp <= 0;
            document.getElementById('end-btn').disabled = !isMyTurn;
            document.getElementById('play-btn').innerText = `ì¹´ë“œ ì‚¬ìš© (${cardsToPlay.length} AP)`;

            // 6. ë¡œê·¸ (ë¡œê·¸ ë°°ì—´ ê¸¸ì´ë¡œ ì—…ë°ì´íŠ¸ í™•ì¸)
            const logs = gameData.logHistory || [];
            if (elLogBox && elLogBox.children.length !== logs.length) {
                elLogBox.innerHTML = ''; 
                logs.forEach(logText => {
                    const p = document.createElement('p');
                    p.innerHTML = logText;
                    elLogBox.appendChild(p);
                });
                elLogBox.scrollTop = elLogBox.scrollHeight;
            }
        }
        
        // í—¬í¼: í˜„ì¬ ì„ íƒëœ ì¹´ë“œ ëª©ë¡ ë°˜í™˜
        function selectedCards() {
            const myHand = gameData[myRole].hand || [];
            return myHand.filter(c => selectedCardIds.includes(c.id));
        }

        function renderHand(container, cards, isOpponent) {
            if (!container) return; // Defensive check
            container.innerHTML = "";
            cards.forEach(card => {
                const el = document.createElement('div');
                el.className = `card ${isOpponent ? 'hidden' : 'type-'+(card.type==='disaster'?'disaster':card.type)}`;
                
                if(!isOpponent) {
                    el.innerHTML = `<div class="card-name">${card.name}</div>`;
                    if(card.type === 'disaster') el.innerHTML += `<div class="card-info" style="color:#d32f2f">í”¼í•´: ${card.dmg}</div><div class="card-type-label">${card.dType}</div>`;
                    else el.innerHTML += `<div class="card-info" style="color:#007bff">ë¹„ìš©: ${card.cost}</div><div class="card-info">ë°©ì–´: ${card.power}</div><div class="card-type-label">${card.phase || card.subType}</div>`;
                    
                    if(selectedCardIds.includes(card.id)) el.classList.add('selected');
                    el.onclick = () => toggleSelect(card.id);
                }
                container.appendChild(el);
            });
        }

        function renderField(container, cards) {
            if (!container) return; // Defensive check
            container.innerHTML = "";
            cards.forEach(card => {
                const el = document.createElement('div');
                el.className = `card type-${card.type === 'mitigation' ? 'mitigation' : 'general'}`;
                el.innerHTML = `<div class="card-name">${card.name}</div><div class="card-info">ë°©ì–´: ${card.power}</div><div class="card-type-label">${card.phase || card.subType}</div>`;
                container.appendChild(el);
            });
        }

        function toggleSelect(id) {
            if(gameData.turn !== myRole) return;
            
            if(selectedCardIds.includes(id)) {
                selectedCardIds = selectedCardIds.filter(x => x !== id);
            } else {
                selectedCardIds.push(id);
            }
            renderGame();
        }

        // --- ì•¡ì…˜ ë¡œì§ ---

        // ë‰´ìŠ¤ ëª¨ë‹¬ í™•ì¸ ë²„íŠ¼ (Confirm News)
        document.getElementById('confirm-news-btn').addEventListener('click', async () => {
             document.getElementById('news-modal').style.display = 'none';
             if (gameData.status === 'news_shown') {
                await update(ref(db, `rooms/${roomId}`), { status: 'playing' });
             }
        });

        // 1. ì¹´ë“œ ë½‘ê¸° (ë³„ë„ ì•¡ì…˜)
        document.getElementById('draw-btn').addEventListener('click', async () => {
            const myData = gameData[myRole];
            if(myData.ap < 1) return alert("APê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.");
            
            const updates = {};
            const deck = [...(gameData.deck || [])];
            if(deck.length === 0) return alert("ë±ì´ ë¹„ì—ˆìŠµë‹ˆë‹¤!");
            
            const card = deck.pop();
            const myHand = [...(myData.hand || [])];
            myHand.push(card);

            const logHistory = [...(gameData.logHistory || [])];
            logHistory.push(`${myRole}ê°€ ì¹´ë“œë¥¼ 1ì¥ ë½‘ì•˜ìŠµë‹ˆë‹¤. (1 AP ì‚¬ìš©)`);

            updates[`rooms/${roomId}/deck`] = deck;
            updates[`rooms/${roomId}/${myRole}/hand`] = myHand;
            updates[`rooms/${roomId}/${myRole}/ap`] = myData.ap - 1;
            updates[`rooms/${roomId}/logHistory`] = logHistory;

            await update(ref(db), updates);
        });

        // 2. í”¼í•´ ë³µêµ¬ (Recovery)
        document.getElementById('recover-btn').addEventListener('click', async () => {
            const myData = gameData[myRole];
            if (myData.ap < 1) return alert("AP ë¶€ì¡±");
            if (myData.hp <= 0) return alert("ë³µêµ¬í•  í”¼í•´ ì—†ìŒ");
            
            let multiplier = 2;
            if (gameData.currentEvent.type === 'recover_nerf') multiplier = 3;
            if (gameData.currentEvent.type === 'recover_buff') multiplier = 1.5;

            const maxRecoverable = Math.floor(myData.money / multiplier);
            const realMax = Math.min(myData.hp, maxRecoverable);

            if (realMax <= 0) return alert(`ì˜ˆì‚° ë¶€ì¡± (ë¹„ìš© ë°°ìœ¨: x${multiplier})`);

            const input = prompt(`ë³µêµ¬í•  í”¼í•´ëŸ‰ ì…ë ¥ (ìµœëŒ€ ${realMax})\ní˜„ì¬ ë¹„ìš© ë°°ìœ¨: x${multiplier}`);
            if (input === null) return;
            const amount = parseInt(input);
            
            if (isNaN(amount) || amount <= 0 || amount > realMax) return alert("ìœ íš¨í•œ ìˆ«ì ì…ë ¥ ìš”ë§");

            const cost = Math.floor(amount * multiplier);
            
            const logHistory = [...(gameData.logHistory || [])];
            logHistory.push(`${myRole}ê°€ í”¼í•´ ${amount} ë³µêµ¬ ì™„ë£Œ (ë¹„ìš©: ${cost}). (1 AP ì‚¬ìš©)`);

            const updates = {};
            updates[`rooms/${roomId}/${myRole}/money`] = myData.money - cost;
            updates[`rooms/${roomId}/${myRole}/hp`] = myData.hp - amount;
            updates[`rooms/${roomId}/${myRole}/ap`] = myData.ap - 1;
            updates[`rooms/${roomId}/logHistory`] = logHistory;

            await update(ref(db), updates);
        });

        // 3. ì¹´ë“œ ì‚¬ìš© (í•µì‹¬)
        document.getElementById('play-btn').addEventListener('click', async () => {
            const cardsToPlay = selectedCards();
            if(cardsToPlay.length === 0) return;

            const myData = gameData[myRole];
            
            // 1. ë¹„ìš© ê³„ì‚° ë° ì²´í¬
            let totalCost = 0;
            const evt = gameData.currentEvent;
            
            const mitigations = cardsToPlay.filter(c => c.type !== 'disaster');
            const disasters = cardsToPlay.filter(c => c.type === 'disaster');

            mitigations.forEach(c => {
                let cost = c.cost;
                if(evt.type === 'cost_up') cost += evt.val;
                if(evt.type === 'cost_down') cost = Math.max(0, cost - evt.val);
                totalCost += cost;
            });

            if(myData.money < totalCost) return alert(`ì˜ˆì‚° ë¶€ì¡± (í•„ìš”: ${totalCost})`);

            // 2. DB ì—…ë°ì´íŠ¸ ì¤€ë¹„
            const updates = {};
            const oppRole = (myRole === 'host') ? 'guest' : 'host';
            let oppHp = gameData[oppRole].hp;
            let logMsg = "";

            // 3. ë°©ì¬ ì¹´ë“œ ì„¤ì¹˜
            if(mitigations.length > 0) {
                const newField = [...(myData.field || []), ...mitigations];
                updates[`rooms/${roomId}/${myRole}/field`] = newField;
                logMsg += `${myRole}ê°€ ë°©ì¬ì‹œì„¤ ${mitigations.length}ê°œë¥¼ ì„¤ì¹˜í–ˆìŠµë‹ˆë‹¤. (ë¹„ìš©: ${totalCost}). `;
            }

            // 4. ì¬ë‚œ ì¹´ë“œ ê³µê²© (ì½¤ë³´ ë° ë°©ì–´ ë¡œì§ ì ìš©)
            if(disasters.length > 0) {
                const oppField = gameData[oppRole].field || [];
                let totalDmg = 0;
                let damageLog = [];

                disasters.forEach(d => {
                    let dmg = d.dmg;
                    let defenseLog = "";

                    // A. ê³µê²©ë ¥ ê³„ì‚° (ì´ë²¤íŠ¸ ë° ìƒì„±)
                    if(evt.type === 'attack_buff') dmg = Math.floor(dmg * evt.val);
                    if(d.dType === gameData[oppRole].city.weakType) { 
                        dmg = Math.floor(dmg * 1.5); 
                        defenseLog += `[ì•½ì ê³µëµ!] `;
                    }
                    
                    // B. ë°©ì–´ ê³„ì‚° (ì½¤ë³´ ê³„ì‚° í—¬í¼ ì‚¬ìš©)
                    const mitigationPower = calculateMitigationPowerOnline(oppField, d);

                    const finalDmg = Math.max(0, dmg - mitigationPower);
                    totalDmg += finalDmg;
                    
                    damageLog.push(`${d.name}: ${dmg} ê³µê²© - ${mitigationPower} ë°©ì–´ = ${finalDmg} í”¼í•´`);
                });
                
                oppHp += totalDmg;
                updates[`rooms/${roomId}/${oppRole}/hp`] = oppHp;
                
                logMsg += `${myRole}ê°€ ì¬ë‚œìœ¼ë¡œ ì´ <b>${totalDmg}</b>ì˜ í”¼í•´ë¥¼ ì…í˜”ìŠµë‹ˆë‹¤! `;
            }

            // 5. ìì› ì°¨ê° ë° í•¸ë“œ ì •ë¦¬
            const remainingHand = myData.hand.filter(c => !selectedCardIds.includes(c.id));
            
            const logHistory = [...(gameData.logHistory || [])];
            logHistory.push(logMsg);

            updates[`rooms/${roomId}/${myRole}/hand`] = remainingHand;
            updates[`rooms/${roomId}/${myRole}/money`] = myData.money - totalCost;
            updates[`rooms/${roomId}/${myRole}/ap`] = myData.ap - cardsToPlay.length;
            updates[`rooms/${roomId}/logHistory`] = logHistory;

            await update(ref(db), updates);
            selectedCardIds = []; // ì„ íƒ ì´ˆê¸°í™”
        });

        // 4. í„´ ì¢…ë£Œ (ì¹´ë“œ ë“œë¡œìš° ë° ë¦¬ì…‹ ë¡œì§ í¬í•¨)
        document.getElementById('end-btn').addEventListener('click', async () => {
            const updates = {};
            const nextTurn = (myRole === 'host') ? 'guest' : 'host';
            const nextEvent = EVENTS[Math.floor(Math.random() * EVENTS.length)];
            
            // í„´ ë¦¬ì…‹
            const nextData = gameData[nextTurn];
            updates[`rooms/${roomId}/${nextTurn}/ap`] = 2; // AP ë¦¬ì…‹
            updates[`rooms/${roomId}/${nextTurn}/money`] = nextData.money + 100; // ì˜ˆì‚° ì§€ê¸‰
            
            // ğŸ’¡ í„´ ì‹œì‘ ì¹´ë“œ ë“œë¡œìš°
            const deck = [...(gameData.deck || [])];
            const nextHand = [...(nextData.hand || [])];
            
            let cardDrawMsg = "";
            if (deck.length > 0) {
                const card = deck.pop();
                nextHand.push(card);
                updates[`rooms/${roomId}/deck`] = deck;
                updates[`rooms/${roomId}/${nextTurn}/hand`] = nextHand;
                cardDrawMsg = `ì¹´ë“œ 1ì¥ ë“œë¡œìš°.`;
            } else {
                cardDrawMsg = `ë±ì´ ë¹„ì—ˆìŠµë‹ˆë‹¤. ë“œë¡œìš° ì‹¤íŒ¨.`;
            }

            // ë¡œê·¸ ì—…ë°ì´íŠ¸
            const logHistory = [...(gameData.logHistory || [])];
            logHistory.push(`--- í„´ ì¢…ë£Œ! ${nextTurn}ì˜ ì°¨ë¡€ (ë‰´ìŠ¤: ${nextEvent.name}). ${cardDrawMsg} ---`);
            updates[`rooms/${roomId}/logHistory`] = logHistory;

            // í„´ ì •ë³´ ì—…ë°ì´íŠ¸
            updates[`rooms/${roomId}/turn`] = nextTurn;
            updates[`rooms/${roomId}/turnCount`] = gameData.turnCount + 1;
            updates[`rooms/${roomId}/currentEvent`] = nextEvent;
            updates[`rooms/${roomId}/status`] = 'waiting_for_news'; // ë‰´ìŠ¤ ëª¨ë‹¬ì„ ë„ìš°ê¸° ìœ„í•œ ìƒíƒœ ì „í™˜

            await update(ref(db), updates);
        });

        // --- ê²Œì„ ì¢…ë£Œ í™•ì¸ ---
        function checkGameOver() {
            if(!gameData || gameData.status === 'ended') return;

            const hostDmg = gameData.host.hp;
            const guestDmg = gameData.guest.hp;
            const hostMaxHp = gameData.host.city.maxHp;
            const guestMaxHp = gameData.guest.city.maxHp;
            let winner = null;
            let reason = "";

            if(hostDmg >= hostMaxHp) { winner = "Guest"; reason = "Host ë„ì‹œ íŒŒì‚° (í”¼í•´ëŸ‰ 2000 ì´ˆê³¼)"; }
            else if(guestDmg >= guestMaxHp) { winner = "Host"; reason = "Guest ë„ì‹œ íŒŒì‚° (í”¼í•´ëŸ‰ 2000 ì´ˆê³¼)"; }
            else if(gameData.turnCount > 20) { // 20í„´ ì œí•œ (ë°¸ëŸ°ìŠ¤)
                if(hostDmg < guestDmg) { winner = "Host"; reason = "20í„´ ì´ˆê³¼! í”¼í•´ëŸ‰ ì ì€ Host ìŠ¹ë¦¬"; }
                else if(guestDmg < hostDmg) { winner = "Guest"; reason = "20í„´ ì´ˆê³¼! í”¼í•´ëŸ‰ ì ì€ Guest ìŠ¹ë¦¬"; }
                else { winner = "Draw"; reason = "20í„´ ì´ˆê³¼! ë™ì  ë¬´ìŠ¹ë¶€"; }
            }

            if(winner) {
                document.getElementById('result-modal').style.display = 'flex';
                document.getElementById('result-title').innerText = winner === 'Draw' ? "ë¬´ìŠ¹ë¶€" : `${winner} ìŠ¹ë¦¬!`;
                document.getElementById('result-desc').innerText = reason;
                // DBì— ì¢…ë£Œ ìƒíƒœ ê¸°ë¡ (ë¬´í•œë£¨í”„ ë°©ì§€)
                if(myRole === 'host') update(ref(db, `rooms/${roomId}`), { status: 'ended' });
            }
        }
    </script>
</body>
</html>
