<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¬ë‚œ ê´€ë¦¬ ì¹´ë“œ ê²Œì„ (Final - Intro Added)</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #f0f2f5; color: #333; margin: 0; padding: 20px;
        }

        /* 0. ì¸íŠ¸ë¡œ í™”ë©´ (ì¶”ê°€ë¨) */
        #intro-screen {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white; z-index: 5000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .intro-box {
            background-color: rgba(255, 255, 255, 0.95);
            color: #333;
            padding: 40px; border-radius: 20px;
            max-width: 700px; width: 90%;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            animation: fadeIn 0.5s ease-out;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        .intro-title { font-size: 2.5em; font-weight: bold; color: #0056b3; margin-bottom: 20px; }
        .intro-section { margin-bottom: 25px; text-align: left; border-bottom: 1px solid #eee; padding-bottom: 15px; }
        .intro-section h3 { color: #d32f2f; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }
        .intro-list li { margin-bottom: 8px; line-height: 1.6; font-size: 1.1em; }
        .highlight { font-weight: bold; color: #d32f2f; background-color: #ffebee; padding: 2px 5px; border-radius: 4px; }
        
        #game-start-btn {
            font-size: 1.5em; padding: 15px 50px; cursor: pointer;
            background-color: #28a745; color: white; border: none; border-radius: 50px;
            transition: transform 0.2s, background-color 0.2s;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4);
            font-weight: bold; margin-top: 10px;
        }
        #game-start-btn:hover { transform: scale(1.05); background-color: #218838; }

        /* 1. í„´ ëŒ€ê¸° ì˜¤ë²„ë ˆì´ */
        #turn-overlay {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background-color: rgba(0, 0, 0, 0.95); color: white; z-index: 2000;
            display: none; /* ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€ (ì¸íŠ¸ë¡œ ë¨¼ì €) */
            flex-direction: column; justify-content: center;
            align-items: center; text-align: center;
        }
        #turn-overlay h1 { font-size: 3em; margin-bottom: 20px; }
        #turn-overlay p { font-size: 1.5em; margin-bottom: 40px; color: #ccc; }
        #start-turn-btn {
            font-size: 1.5em; padding: 15px 40px; cursor: pointer;
            background-color: #007bff; color: white; border: none; border-radius: 8px;
            transition: transform 0.2s;
        }
        #start-turn-btn:hover { transform: scale(1.05); background-color: #0056b3; }

        /* ê²°ê³¼ ìš”ì•½ í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        .summary-box {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            min-width: 300px;
            text-align: left;
        }
        .summary-table {
            width: 100%;
            border-collapse: collapse;
            color: white;
            font-size: 1.1em;
        }
        .summary-table th, .summary-table td {
            padding: 10px;
            text-align: center;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }
        .summary-table th { color: #aaa; font-weight: normal; font-size: 0.9em; }
        .summary-table td:first-child { text-align: left; font-weight: bold; color: #ddd; }
        .val-bad { color: #ff6b6b; font-weight: bold; }
        .val-good { color: #51cf66; font-weight: bold; }

        /* 2. ë‰´ìŠ¤ ì†ë³´ ëª¨ë‹¬ */
        #news-modal {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background-color: rgba(0, 0, 0, 0.85); z-index: 3000;
            display: none;
            justify-content: center; align-items: center;
        }
        .news-content {
            background-color: white; width: 90%; max-width: 600px;
            padding: 40px; border-radius: 15px; text-align: center;
            box-shadow: 0 0 50px rgba(255, 255, 255, 0.3);
            animation: popUp 0.3s ease-out;
        }
        @keyframes popUp { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        .news-badge {
            display: inline-block; padding: 8px 20px; border-radius: 25px;
            font-weight: bold; color: white; margin-bottom: 20px; font-size: 1.2em;
        }
        .bg-bad { background-color: #dc3545; }
        .bg-good { background-color: #28a745; }
        .bg-normal { background-color: #6c757d; }

        .news-title { font-size: 2.5em; font-weight: bold; margin-bottom: 20px; color: #333; }
        .news-desc { font-size: 1.4em; color: #555; margin-bottom: 40px; line-height: 1.6; }
        
        #confirm-news-btn {
            font-size: 1.3em; padding: 15px 40px; cursor: pointer;
            background-color: #333; color: white; border: none; border-radius: 8px;
            font-weight: bold;
        }
        #confirm-news-btn:hover { background-color: #555; }

        /* 3. ê²Œì„ ë©”ì¸ í™”ë©´ */
        #game-container { 
            display: none; max-width: 1000px; margin: 0 auto; 
            background-color: #f0f2f5; padding: 20px; border-radius: 15px;
        }

        #active-news-ticker {
            background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba;
            padding: 12px; margin-bottom: 20px; border-radius: 8px;
            font-weight: bold; text-align: center; font-size: 1.1em;
            display: flex; justify-content: center; align-items: center; gap: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .player-area {
            border: 2px solid #ccc; border-radius: 10px; padding: 20px;
            margin-bottom: 20px; background-color: #ffffff;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        .player-area.active-turn { border: 3px solid #007bff; box-shadow: 0 0 20px rgba(0,123,255,0.3); }
        
        .status-bar {
            display: flex; justify-content: space-between; align-items: center;
            padding-bottom: 15px; border-bottom: 1px solid #eee; margin-bottom: 15px;
        }
        .status-bar h2 { margin: 0; font-size: 1.8em; color: #111; display: flex; align-items: center; }
        
        .city-badge {
            font-size: 0.5em; background-color: #495057; color: white; 
            padding: 5px 10px; border-radius: 15px; margin-left: 10px; vertical-align: middle;
        }
        .weakness-highlight { color: #ff6b6b; font-weight: bold; margin-left: 5px; }

        .player-stats { display: flex; gap: 15px; text-align: right; }
        .stat-box {
            font-size: 1.1em; font-weight: 700; background-color: #f8f9fa;
            padding: 8px 12px; border-radius: 6px; display: flex; align-items: center; gap: 5px;
        }
        .currency { color: #28a745; }
        .damage { color: #dc3545; }
        .ap { color: #007bff; }

        /* ë°©ì–´ë ¥ ëŒ€ì‹œë³´ë“œ */
        .defense-dashboard {
            display: flex; flex-direction: column;
            gap: 5px; margin-bottom: 15px; padding: 10px;
            background-color: #e8f5e9; border-radius: 8px; border: 1px solid #c8e6c9;
        }
        .defense-row {
            display: flex; justify-content: space-around; width: 100%; gap: 10px;
        }
        .def-category { 
            display: flex; flex-direction: column; font-size: 0.9em; text-align: center; 
            flex: 1; padding: 8px; border-radius: 8px; background-color: white;
            border: 1px solid #ddd; transition: all 0.3s;
        }
        .def-title { font-weight: bold; margin-bottom: 8px; color: #2e7d32; border-bottom: 1px solid #eee; padding-bottom: 4px;}
        .def-item { display: flex; justify-content: space-between; gap: 5px; margin-bottom: 2px;}
        .def-val { font-weight: bold; }
        
        .def-category.weak {
            background-color: #ffebee; border: 2px solid #ef5350; transform: scale(1.02); box-shadow: 0 2px 5px rgba(255,0,0,0.1);
        }
        .def-category.weak .def-title { color: #c62828; }
        .weak-label { 
            font-size: 0.7em; background-color: #ef5350; color: white; 
            padding: 2px 6px; border-radius: 4px; margin-left: 5px; vertical-align: text-top;
        }

        .area-title {
            font-size: 1.1em; font-weight: 600; color: #555;
            margin: 15px 0 10px 0; border-bottom: 2px solid #eee; padding-bottom: 5px;
        }
        .card-container {
            display: flex; flex-wrap: wrap; gap: 10px; min-height: 120px;
            background-color: #f8f9fa; border-radius: 8px; padding: 15px;
        }

        .card {
            width: 110px; height: 160px; background-color: #fff; border: 2px solid #ddd;
            border-radius: 8px; padding: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            cursor: pointer; transition: transform 0.1s ease;
            display: flex; flex-direction: column; justify-content: space-between;
            font-size: 0.9em; user-select: none;
        }
        .card:hover { transform: translateY(-5px) scale(1.03); z-index: 10; }
        
        /* ì„ íƒëœ ì¹´ë“œ ê°•ì¡° ìŠ¤íƒ€ì¼ ê°•í™” */
        .card.selected { 
            border: 3px solid #007bff !important; 
            background-color: #e3f2fd !important;
            transform: scale(1.05); 
            box-shadow: 0 0 15px rgba(0,123,255,0.4) !important;
        }
        
        .card-name { font-weight: 700; font-size: 1em; margin-bottom: 5px; line-height: 1.2; }
        .card-info { font-size: 0.85em; color: #444; }
        .card-type-label { font-size: 0.75em; font-style: italic; color: #777; margin-top: auto; }
        
        .card.type-disaster { border-left: 5px solid #dc3545; }
        .card.type-mitigation { border-left: 5px solid #28a745; }
        .card.type-general { border-left: 5px solid #ffc107; }

        .hand.opponent .card { background-color: #555; color: #aaa; border-color: #444; justify-content: center; align-items: center; }
        .hand.opponent .card::before { content: "CARD"; font-weight: bold; font-size: 1.2em; opacity: 0.3; }
        .hand.opponent .card * { display: none; }
        
        .card.obfuscated { background-color: #e9ecef; border-left: 5px solid #6c757d; color: #495057; }

        #controls {
            display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px; margin-top: 20px;
        }
        .control-btn {
            padding: 15px; font-size: 1em; font-weight: 600;
            cursor: pointer; border: none; border-radius: 8px; color: white;
            transition: filter 0.2s;
        }
        .control-btn:hover { filter: brightness(90%); }
        .control-btn:disabled { background-color: #ccc !important; cursor: not-allowed; filter: none; }
        
        #play-selected-btn { background-color: #28a745; grid-column: span 2; }
        #draw-card-btn { background-color: #007bff; }
        #recover-btn { background-color: #ffc107; color: #212529; }
        #end-turn-btn { background-color: #dc3545; grid-column: span 4; margin-top: 10px; }

        #message-log {
            margin-top: 20px; background-color: #fff; border: 1px solid #ddd;
            border-radius: 8px; padding: 15px; height: 150px; overflow-y: auto; font-size: 0.9em;
        }
        .log-turn { font-weight: bold; color: #007bff; margin-top: 8px; border-top: 1px dashed #eee; padding-top: 4px; }
        .log-action { color: #28a745; }
        .log-damage { color: #dc3545; }
        .log-info { color: #6c757d; }
        .log-news { color: #856404; font-weight: bold; background-color: #fff3cd; padding: 2px 5px; border-radius: 3px; }
    </style>
</head>
<body>

    <div id="intro-screen">
        <div class="intro-box">
            <div class="intro-title">ğŸŒªï¸ ì¬ë‚œ ê´€ë¦¬ ì¹´ë“œ ê²Œì„</div>
            
            <div class="intro-section">
                <h3>ğŸ“‹ ê²Œì„ ì†Œê°œ</h3>
                <p>ë‹¹ì‹ ì€ ë„ì‹œì˜ ì•ˆì „ì„ ì±…ì„ì§€ëŠ” <b>ë°©ì¬ ë‹´ë‹¹ê´€</b>ì…ë‹ˆë‹¤. í•œì •ëœ ì˜ˆì‚°ìœ¼ë¡œ íš¨ìœ¨ì ì¸ ë°©ì¬ ì‹œì„¤ì„ ì„¤ì¹˜í•˜ê³ , ìì—°ì¬í•´ì™€ ì¸ê³µì¬ë‚œìœ¼ë¡œë¶€í„° ì‹œë¯¼ì„ ë³´í˜¸í•˜ì„¸ìš”. ë™ì‹œì— ìƒëŒ€ ë„ì‹œì˜ ì•½ì ì„ ê³µëµí•˜ì—¬ ê²½ìŸì—ì„œ ìŠ¹ë¦¬í•´ì•¼ í•©ë‹ˆë‹¤.</p>
            </div>

            <div class="intro-section">
                <h3>ğŸ’¡ í•µì‹¬ ìŠ¹ë¦¬ ì „ëµ (í•™ìŠµ í¬ì¸íŠ¸)</h3>
                <ul class="intro-list" style="text-align: left; padding-left: 20px;">
                    <li><b>ì§€ì—­ë³„ ì·¨ì•½ì  ê³µëµ:</b> ê° ë„ì‹œëŠ” ê³ ìœ í•œ ì§€í˜•(í•´ì•ˆ, ë…¸í›„ë„ì‹¬, ì‚°ê°„)ì„ ê°€ì§‘ë‹ˆë‹¤. ìƒëŒ€ ë„ì‹œì˜ <span class="highlight">ì·¨ì•½ ì¬ë‚œìœ¼ë¡œ ê³µê²©í•˜ë©´ 1.5ë°°ì˜ í”¼í•´</span>ë¥¼ ì¤ë‹ˆë‹¤.</li>
                    <li><b>ë°©ì¬ ì½¤ë³´ êµ¬ì¶•:</b> ë™ì¼ ì¬ë‚œì— ëŒ€í•´ <span class="highlight">[ì˜ˆë°©] + [ì¤€ë¹„] ì‹œì„¤ì„ ëª¨ë‘ ì„¤ì¹˜</span>í•˜ë©´ ê°•ë ¥í•œ ì‹œë„ˆì§€ ë³´ë„ˆìŠ¤ë¥¼ ì–»ìŠµë‹ˆë‹¤.</li>
                    <li><b>ìê¸ˆ ê´€ë¦¬:</b> ë¬´ì¡°ê±´ì ì¸ ì¹´ë“œ ì‚¬ìš©ë³´ë‹¤ëŠ” ìƒí™©ì— ë§ëŠ” ì €ì¶•ê³¼ ì‹œì„¤ íˆ¬ìê°€ ì¤‘ìš”í•©ë‹ˆë‹¤.</li>
                </ul>
            </div>

            <button id="game-start-btn">ê²Œì„ ì‹œì‘</button>
        </div>
    </div>

    <div id="turn-overlay">
        <h1 id="overlay-player-name">í”Œë ˆì´ì–´ 1ë‹˜ì˜ í„´ì…ë‹ˆë‹¤.</h1>
        <div id="overlay-content">
            <p>ìƒëŒ€ë°©ì€ í™”ë©´ì„ ë³´ì§€ ë§ˆì„¸ìš”.</p>
        </div>
        <button id="start-turn-btn">í„´ ì‹œì‘í•˜ê¸°</button>
    </div>

    <div id="news-modal">
        <div class="news-content">
            <div id="news-badge" class="news-badge bg-normal">ì¼ì¼ ì¬ë‚œ ë¸Œë¦¬í•‘</div>
            <div id="news-title" class="news-title">ë‰´ìŠ¤ ì œëª©</div>
            <div id="news-desc" class="news-desc">ë‰´ìŠ¤ ë‚´ìš©</div>
            <button id="confirm-news-btn">í™•ì¸ (ì‘ì „ ê°œì‹œ)</button>
        </div>
    </div>

    <div id="game-container">
        
        <div id="active-news-ticker">
            <span style="font-size:1.2em">ğŸ“°</span>
            <span id="ticker-text">í˜„ì¬ ì ìš© ì¤‘ì¸ ë‰´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.</span>
        </div>

        <div id="my-area" class="player-area active-turn">
            <div class="status-bar">
                <h2>
                    <span id="my-name">í”Œë ˆì´ì–´ 1</span>
                    <span id="my-city-badge" class="city-badge"></span>
                </h2>
                <div class="player-stats">
                    <div class="stat-box ap">âš¡ AP: <span id="my-ap-val">2</span></div>
                    <div class="stat-box damage">ğŸ’” í”¼í•´: <span id="my-damage-val">0</span></div>
                    <div class="stat-box currency">ğŸ’° ì˜ˆì‚°: <span id="my-currency-val">1000</span></div>
                </div>
            </div>
            
            <div id="my-defense-stats" class="defense-dashboard"></div>

            <div class="area-title">ì„¤ì¹˜ëœ ì‹œì„¤</div>
            <div id="my-field" class="card-container field"></div>
            
            <div class="area-title">ë³´ìœ  ì¹´ë“œ (í´ë¦­í•˜ì—¬ ì„ íƒ)</div>
            <div id="my-hand" class="card-container hand"></div>
        </div>

        <div id="opponent-area" class="player-area">
            <div class="status-bar">
                <h2>
                    <span id="opponent-name">í”Œë ˆì´ì–´ 2</span>
                    <span id="opponent-city-badge" class="city-badge"></span>
                </h2>
                <div class="player-stats">
                    <div class="stat-box ap" style="opacity:0.5">AP: ?</div>
                    <div class="stat-box damage">ğŸ’” í”¼í•´: <span id="opponent-damage-val">0</span></div>
                    <div class="stat-box currency">ğŸ’° ì˜ˆì‚°: <span id="opponent-currency-val">1000</span></div>
                </div>
            </div>
            <div class="area-title">ìƒëŒ€ ë„ì‹œ ì‹œì„¤ (ì •ë³´ ì œí•œë¨)</div>
            <div id="opponent-field" class="card-container field"></div>
            <div class="area-title">ìƒëŒ€ ì†íŒ¨</div>
            <div id="opponent-hand" class="card-container hand opponent"></div>
        </div>

        <div id="controls">
            <button id="play-selected-btn" class="control-btn">ì¹´ë“œ ì‚¬ìš© (1 AP)</button>
            <button id="draw-card-btn" class="control-btn">ì¹´ë“œ ë½‘ê¸° (1 AP)</button>
            <button id="recover-btn" class="control-btn">í”¼í•´ ë³µêµ¬ (1 AP)</button>
            <button id="end-turn-btn" class="control-btn">í„´ ì¢…ë£Œ</button>
        </div>

        <div id="message-log"><p class="log-info">ê²Œì„ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.</p></div>
    </div>

    <script>
        window.onload = function() {
            console.log("Game Script Loaded");
            // ì¸íŠ¸ë¡œ í™”ë©´ì´ ìˆìœ¼ë¯€ë¡œ alertëŠ” ì œê±°í•˜ê±°ë‚˜ ì¸íŠ¸ë¡œ ì´í›„ë¡œ ë¯¸ë£¸
        };

        const DisasterType = { WINTER: "ê²¨ìš¸ì²  ì¬ë‚œ", WIND_FLOOD: "í’ìˆ˜í•´", MOUNTAIN: "ì‚°ì•… ì¬ë‚œ" };
        const MitigationPhase = { PREVENTION: "ì˜ˆë°©", PREPAREDNESS: "ì¤€ë¹„", GENERAL: "ë²”ìš©" };

        const CITY_TYPES = [
            { name: "ğŸŒŠ í•´ì•ˆ ë„ì‹œ", weakType: DisasterType.WIND_FLOOD, desc: "í’ìˆ˜í•´(íƒœí’,í­ìš°)ì— ì·¨ì•½", weakText: "í’ìˆ˜í•´ ì·¨ì•½" },
            { name: "ğŸšï¸ ë…¸í›„ ë„ì‹¬", weakType: DisasterType.WINTER, desc: "ë…¸í›„ ì£¼íƒ ë°€ì§‘ìœ¼ë¡œ ê²¨ìš¸ì² (ëŒ€ì„¤,í•œíŒŒ)ì— ì·¨ì•½", weakText: "ê²¨ìš¸ì²  ì·¨ì•½" },
            { name: "â›°ï¸ ì‚°ê°„ ì§€ì—­", weakType: DisasterType.MOUNTAIN, desc: "ê¸‰ê²½ì‚¬ì§€ë¡œ ì‚°ì•…(ì‚°ë¶ˆ,ì‚°ì‚¬íƒœ)ì— ì·¨ì•½", weakText: "ì‚°ì•… ì¬ë‚œ ì·¨ì•½" }
        ];

        const EVENTS = [
            { id: 'normal', name: "â˜€ï¸ í‰ì˜¨í•œ ë‚ ", desc: "íŠ¹ì´í•œ ê¸°ìƒ ì§•í›„ë‚˜ ì‚¬íšŒì  ì´ìŠˆê°€ ì—†ìŠµë‹ˆë‹¤.", type: "normal", val: 0, badge: "í‰ì˜¨", bg: "bg-normal" },
            { id: 'climate', name: "âš ï¸ ê¸°í›„ ì´ìƒ ê°ì§€", desc: "ì´ë²ˆ í„´ì— ë‚´ê°€ ì‚¬ìš©í•˜ëŠ” <b>ì¬ë‚œ ì¹´ë“œì˜ ê³µê²©ë ¥ì´ 1.5ë°°</b> ì¦ê°€í•©ë‹ˆë‹¤.", type: "attack_buff", val: 1.5, badge: "ìœ„ê¸°", bg: "bg-bad" },
            { id: 'inflation', name: "ğŸ’¸ ì›ìì¬ ê°€ê²© í­ë“±", desc: "ì´ë²ˆ í„´ì— <b>ë°©ì¬ ì‹œì„¤ ì„¤ì¹˜ ë¹„ìš©ì´ 50ì› ì¦ê°€</b>í•©ë‹ˆë‹¤.", type: "cost_up", val: 50, badge: "ìœ„ê¸°", bg: "bg-bad" },
            { id: 'delay', name: "ğŸ“‰ ë³µêµ¬ ì‘ì—… ì§€ì—°", desc: "ì¸ë ¥ ë¶€ì¡±ìœ¼ë¡œ <b>í”¼í•´ ë³µêµ¬ ë¹„ìš©ì´ 3ë°°</b>ë¡œ ì¦ê°€í•©ë‹ˆë‹¤.", type: "recover_nerf", val: 3, badge: "ìœ„ê¸°", bg: "bg-bad" },
            { id: 'tech', name: "ğŸ’¡ ë°©ì¬ ê¸°ìˆ  í˜ì‹ ", desc: "ì‹ ê¸°ìˆ  ë„ì…ìœ¼ë¡œ <b>ë°©ì¬ ì‹œì„¤ ì„¤ì¹˜ ë¹„ìš©ì´ 50ì› í• ì¸</b>ë©ë‹ˆë‹¤.", type: "cost_down", val: 50, badge: "ê¸°íšŒ", bg: "bg-good" },
            { id: 'gov', name: "ğŸ¤ ë¯¼ê´€ í˜‘ë ¥ ê°•í™”", desc: "ìì›ë´‰ì‚¬ ì§€ì›ìœ¼ë¡œ <b>í”¼í•´ ë³µêµ¬ ë¹„ìš©ì´ 1.5ë°°</b>ë¡œ ê°ì†Œí•©ë‹ˆë‹¤.", type: "recover_buff", val: 1.5, badge: "ê¸°íšŒ", bg: "bg-good" }
        ];

        class Card {
            constructor(name) { 
                this.name = name; 
                this.id = 'card_' + Date.now() + '_' + Math.floor(Math.random() * 99999);
            }
        }
        class DisasterCard extends Card {
            constructor(name, disasterType, baseDamage) {
                super(name);
                this.disasterType = disasterType;
                this.baseDamage = baseDamage;
                this.cardType = "disaster";
            }
        }
        class MitigationCard extends Card {
            constructor(name, cost, power, mitigationType, phase = null, disasterTarget = null) {
                super(name);
                this.cost = cost;
                this.power = power;
                this.mitigationType = mitigationType;
                this.phase = phase;
                this.disasterTarget = disasterTarget;
                this.cardType = (mitigationType === 'general') ? 'general' : 'mitigation';
            }
        }

        const DISASTER_DATA = [
            new DisasterCard("ëŒ€ì„¤ (50)", DisasterType.WINTER, 50), new DisasterCard("ëŒ€ì„¤ (100)", DisasterType.WINTER, 100), new DisasterCard("ëŒ€ì„¤ (200)", DisasterType.WINTER, 200),
            new DisasterCard("í•œíŒŒ (50)", DisasterType.WINTER, 50), new DisasterCard("í•œíŒŒ (100)", DisasterType.WINTER, 100), new DisasterCard("í•œíŒŒ (200)", DisasterType.WINTER, 200),
            new DisasterCard("í­ìš° (50)", DisasterType.WIND_FLOOD, 50), new DisasterCard("í­ìš° (100)", DisasterType.WIND_FLOOD, 100), new DisasterCard("í­ìš° (200)", DisasterType.WIND_FLOOD, 200),
            new DisasterCard("íƒœí’ (50)", DisasterType.WIND_FLOOD, 50), new DisasterCard("íƒœí’ (100)", DisasterType.WIND_FLOOD, 100), new DisasterCard("íƒœí’ (200)", DisasterType.WIND_FLOOD, 200),
            new DisasterCard("ì‚°ë¶ˆ (50)", DisasterType.MOUNTAIN, 50), new DisasterCard("ì‚°ë¶ˆ (100)", DisasterType.MOUNTAIN, 100), new DisasterCard("ì‚°ë¶ˆ (200)", DisasterType.MOUNTAIN, 200),
            new DisasterCard("ì‚°ì‚¬íƒœ (50)", DisasterType.MOUNTAIN, 50), new DisasterCard("ì‚°ì‚¬íƒœ (100)", DisasterType.MOUNTAIN, 100), new DisasterCard("ì‚°ì‚¬íƒœ (200)", DisasterType.MOUNTAIN, 200),
        ];
        
        const SPECIFIC_MITIGATION_DATA = [
            new MitigationCard("ë„ë¡œ ì—´ì„  ì¼€ì´ë¸” ì„¤ì¹˜", 200, 150, 'specific', MitigationPhase.PREVENTION, "ëŒ€ì„¤"),
            new MitigationCard("ë…¸í›„ ì‹œì„¤ë¬¼ ì§€ë¶• ë³´ê°•", 300, 250, 'specific', MitigationPhase.PREVENTION, "ëŒ€ì„¤"),
            new MitigationCard("ì œì„¤ ì¥ë¹„ í™•ë³´ ë° ìœ ì§€", 50, 30, 'specific', MitigationPhase.PREPAREDNESS, "ëŒ€ì„¤"),
            new MitigationCard("ì œì„¤ì œ ë¹„ì¶•", 100, 70, 'specific', MitigationPhase.PREPAREDNESS, "ëŒ€ì„¤"),

            new MitigationCard("ì·¨ì•½ ì‹œì„¤ ë‹¨ì—´ ë³´ê°•", 200, 150, 'specific', MitigationPhase.PREVENTION, "í•œíŒŒ"),
            new MitigationCard("ë„ì‹œ ê°€ìŠ¤ê´€ ì•ˆì „ ì ê²€", 300, 250, 'specific', MitigationPhase.PREVENTION, "í•œíŒŒ"),
            new MitigationCard("ë‚œë°©ìš©í’ˆ ì§€ì› ë° ì—°ë½ë§ êµ¬ì¶•", 50, 30, 'specific', MitigationPhase.PREPAREDNESS, "í•œíŒŒ"),
            new MitigationCard("ìˆ˜ë„ê´€ ë™íŒŒ ë°©ì§€ í‚¤íŠ¸ ë°°í¬", 100, 70, 'specific', MitigationPhase.PREPAREDNESS, "í•œíŒŒ"),

            new MitigationCard("í•˜ì²œ ì œë°©/ëŒ ë³´ê°•", 200, 150, 'specific', MitigationPhase.PREVENTION, "í­ìš°"),
            new MitigationCard("ë„ì‹œ ë°°ìˆ˜ ìš©ëŸ‰ í™•ëŒ€", 300, 250, 'specific', MitigationPhase.PREVENTION, "í­ìš°"),
            new MitigationCard("ì¬ë‚œ ê²½ë³´/í™ìˆ˜ í†µì œ ì‹œìŠ¤í…œ", 50, 30, 'specific', MitigationPhase.PREPAREDNESS, "í­ìš°"),
            new MitigationCard("ì¹¨ìˆ˜ ì·¨ì•½ì§€ ëª¨ë˜ì£¼ë¨¸ë‹ˆ ë¹„ì¶•", 100, 70, 'specific', MitigationPhase.PREPAREDNESS, "í­ìš°"),

            new MitigationCard("í•´ì•ˆ ë°©íŒŒì œ/ë°©ì¡°ì œ ë³´ê°•", 200, 150, 'specific', MitigationPhase.PREVENTION, "íƒœí’"),
            new MitigationCard("ì „ë ¥/í†µì‹  ì‹œì„¤ ì§€ë°˜ ê³ ì •", 300, 250, 'specific', MitigationPhase.PREVENTION, "íƒœí’"),
            new MitigationCard("ì°½ë¬¸/ë¬¸ ì•ˆì „ ë³´ê°• ì •ì±…", 50, 30, 'specific', MitigationPhase.PREPAREDNESS, "íƒœí’"),
            new MitigationCard("ì–´ì„ /ì„ ë°• ê²°ë°• ë° í”¼í•­ ì¡°ì¹˜", 100, 70, 'specific', MitigationPhase.PREPAREDNESS, "íƒœí’"),

            new MitigationCard("ì‚°ë¶ˆ ì €ì§€ ë°©í™”ì„  êµ¬ì¶•", 200, 150, 'specific', MitigationPhase.PREVENTION, "ì‚°ë¶ˆ"),
            new MitigationCard("ì‚°ë¶ˆ ê°ì‹œ CCTV/íƒ‘ ì„¤ì¹˜", 300, 250, 'specific', MitigationPhase.PREVENTION, "ì‚°ë¶ˆ"),
            new MitigationCard("ë“±ì‚°ë¡œ ì…ì‚° í†µì œ", 50, 30, 'specific', MitigationPhase.PREPAREDNESS, "ì‚°ë¶ˆ"),
            new MitigationCard("ì§„í™” í—¬ê¸°/ì°¨ëŸ‰ ë°°ì¹˜", 100, 70, 'specific', MitigationPhase.PREPAREDNESS, "ì‚°ë¶ˆ"),

            new MitigationCard("ì‚¬ë°©ëŒ ë° ì˜¹ë²½ ê±´ì„¤", 200, 150, 'specific', MitigationPhase.PREVENTION, "ì‚°ì‚¬íƒœ"),
            new MitigationCard("ê¸‰ê²½ì‚¬ì§€ ì‚¬ë©´ ë³´ê°•", 300, 250, 'specific', MitigationPhase.PREVENTION, "ì‚°ì‚¬íƒœ"),
            new MitigationCard("ì‚°ì‚¬íƒœ ì˜ˆë³´ ì‹œìŠ¤í…œ ê°€ë™", 50, 30, 'specific', MitigationPhase.PREPAREDNESS, "ì‚°ì‚¬íƒœ"),
            new MitigationCard("ì£¼ë¯¼ ëŒ€í”¼ì†Œ ì§€ì • ë° ì•ˆë‚´", 100, 70, 'specific', MitigationPhase.PREPAREDNESS, "ì‚°ì‚¬íƒœ"),
        ];

        const GENERAL_MITIGATION_DATA = [
            new MitigationCard(`ì¬ë‚œ ê´€ë¦¬ ì‹œìŠ¤í…œ í†µí•©`, 150, 80, 'general', MitigationPhase.GENERAL, null),
            new MitigationCard(`ì‹œë¯¼ ì•ˆì „ êµìœ¡ í™•ëŒ€`, 100, 50, 'general', MitigationPhase.GENERAL, null),
            new MitigationCard(`ì¬ë‚œ ëŒ€ì‘ ë§¤ë‰´ì–¼ ë°°í¬`, 120, 60, 'general', MitigationPhase.GENERAL, null)
        ];

        class Deck {
            constructor() { this.cards = []; }
            build(cardList) { this.cards = cardList; this.shuffle(); }
            shuffle() {
                for (let i = this.cards.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [this.cards[i], this.cards[j]] = [this.cards[j], this.cards[i]];
                }
            }
            draw(num = 1) {
                const drawn = [];
                for (let i = 0; i < num; i++) {
                    if (this.cards.length > 0) drawn.push(this.cards.pop());
                }
                return drawn;
            }
        }

        class Player {
            constructor(name) {
                this.name = name;
                this.currency = 1000;
                this.hand = [];
                this.activeMitigations = [];
                this.totalDamageTaken = 0;
                this.actionPoints = 0;
                this.cityType = null;
            }
            drawCard(deck, num = 1) {
                this.hand.push(...deck.draw(num));
            }
            
            calculateMitigationPower(disasterName, isSilent = false) {
                let totalPower = 0;
                
                const generalCards = this.activeMitigations.filter(c => c.mitigationType === 'general');
                const numGeneral = generalCards.length;
                if (numGeneral > 0) {
                    const baseGeneralPower = generalCards.reduce((sum, card) => sum + card.power, 0);
                    totalPower += baseGeneralPower * numGeneral;
                }
                
                const specificCards = this.activeMitigations.filter(
                    c => c.mitigationType === 'specific' && disasterName.includes(c.disasterTarget)
                );
                
                if (specificCards.length > 0) {
                    const preventionPower = specificCards.filter(c => c.phase === MitigationPhase.PREVENTION).reduce((sum, c) => sum + c.power, 0);
                    const preparednessPower = specificCards.filter(c => c.phase === MitigationPhase.PREPAREDNESS).reduce((sum, c) => sum + c.power, 0);
                    const baseTotal = preventionPower + preparednessPower;
                    
                    if (preventionPower > 0 && preparednessPower > 0) {
                        const comboBonus = Math.max(preventionPower, preparednessPower);
                        totalPower += baseTotal + comboBonus;
                        if(!isSilent) game.showMessage(`[ë°©ì¬ ì½¤ë³´ ë°œë™!] ${disasterName} ë°©ì¬ ì‹œë„ˆì§€! (+${comboBonus} ë³´ë„ˆìŠ¤)`, 'log-action');
                    } else {
                        totalPower += baseTotal;
                    }
                }
                return totalPower;
            }
            
            takeDamage(damageAmount, disasterName, disasterType, currentEvent = null) {
                let finalDamage = damageAmount;
                let vulnerabilityMsg = "";

                if (this.cityType && this.cityType.weakType === disasterType) {
                    finalDamage = Math.floor(damageAmount * 1.5);
                    vulnerabilityMsg = ` (âš ï¸ì·¨ì•½ì !)`;
                }

                const mitigationPower = this.calculateMitigationPower(disasterName);
                const penetratingDamage = Math.max(0, finalDamage - mitigationPower);
                
                let logMsg = `${this.name}ë‹˜: ${disasterName}${vulnerabilityMsg} í”¼ê²©! (ë°ë¯¸ì§€: ${finalDamage}) | ë°©ì–´: ${mitigationPower} | í”¼í•´: ${penetratingDamage}`;
                
                if (penetratingDamage > 0) {
                    this.totalDamageTaken += penetratingDamage;
                    logMsg += ` | ëˆ„ì : ${this.totalDamageTaken}`;
                } else {
                    logMsg += " | ì™„ë²½ ë°©ì–´!";
                }
                game.showMessage(logMsg, 'log-damage');
                if (this.totalDamageTaken >= 2000) {
                    game.endGame(this);
                }
            }
        }

        class GameManager {
            constructor() {
                this.player1 = new Player("í”Œë ˆì´ì–´ 1");
                this.player2 = new Player("í”Œë ˆì´ì–´ 2");
                this.mainDeck = new Deck();
                this.currentPlayer = this.player1;
                this.selectedCardIds = [];
                this.gameOver = false;
                this.TURN_LIMIT = 20;
                this.currentTurn = 0;
                this.currentEvent = EVENTS[0];

                this.dom = {}; 
                this.setupGame();
                this.initDOMElements();
                this.addEventListeners();
                
                // [ìˆ˜ì •] ë°”ë¡œ ì˜¤ë²„ë ˆì´ë¥¼ ë„ìš°ì§€ ì•Šê³  ì¸íŠ¸ë¡œ í™”ë©´ ëŒ€ê¸°
                // this.prepareTurnOverlay(); 
            }

            setupGame() {
                let allCards = [];
                // ì¬ë‚œ 4ì„¸íŠ¸
                for (let i = 0; i < 4; i++) {
                    DISASTER_DATA.forEach(card => { allCards.push(new DisasterCard(card.name, card.disasterType, card.baseDamage)); });
                }
                // íŠ¹ì • ë°©ì¬ 3ì„¸íŠ¸
                for (let i = 0; i < 3; i++) {
                    SPECIFIC_MITIGATION_DATA.forEach(card => { allCards.push(new MitigationCard(card.name, card.cost, card.power, card.mitigationType, card.phase, card.disasterTarget)); });
                }
                // ë²”ìš© ë°©ì¬ 1ì„¸íŠ¸
                GENERAL_MITIGATION_DATA.forEach(card => { allCards.push(new MitigationCard(card.name, card.cost, card.power, card.mitigationType, card.phase, card.disasterTarget)); });
                
                this.mainDeck.build(allCards); 
                
                this.player1.cityType = CITY_TYPES[Math.floor(Math.random() * CITY_TYPES.length)];
                this.player2.cityType = CITY_TYPES[Math.floor(Math.random() * CITY_TYPES.length)];

                this.player1.drawCard(this.mainDeck, 6);
                this.player2.drawCard(this.mainDeck, 6);
                
                // [ìœ ì§€] ë°¸ëŸ°ìŠ¤ íŒ¨ì¹˜: í”Œë ˆì´ì–´ 2 ì´ˆê¸° ìê¸ˆ +200ì›
                this.player2.currency += 200;
            }

            initDOMElements() {
                this.dom = {
                    introScreen: document.getElementById('intro-screen'),
                    gameStartBtn: document.getElementById('game-start-btn'),

                    overlay: document.getElementById('turn-overlay'),
                    overlayTitle: document.getElementById('overlay-player-name'),
                    overlayContent: document.getElementById('overlay-content'),
                    startTurnBtn: document.getElementById('start-turn-btn'),
                    
                    newsModal: document.getElementById('news-modal'),
                    newsBadge: document.getElementById('news-badge'),
                    newsTitle: document.getElementById('news-title'),
                    newsDesc: document.getElementById('news-desc'),
                    confirmNewsBtn: document.getElementById('confirm-news-btn'),
                    tickerText: document.getElementById('ticker-text'),

                    gameContainer: document.getElementById('game-container'),
                    
                    myName: document.getElementById('my-name'),
                    myCityBadge: document.getElementById('my-city-badge'),
                    myCurrency: document.getElementById('my-currency-val'),
                    myDamage: document.getElementById('my-damage-val'),
                    myAP: document.getElementById('my-ap-val'),
                    myField: document.getElementById('my-field'),
                    myHand: document.getElementById('my-hand'), 
                    myDefenseStats: document.getElementById('my-defense-stats'),

                    opponentName: document.getElementById('opponent-name'),
                    opponentCityBadge: document.getElementById('opponent-city-badge'),
                    opponentCurrency: document.getElementById('opponent-currency-val'),
                    opponentDamage: document.getElementById('opponent-damage-val'),
                    opponentField: document.getElementById('opponent-field'),
                    opponentHand: document.getElementById('opponent-hand'),
                    
                    playBtn: document.getElementById('play-selected-btn'),
                    drawCardBtn: document.getElementById('draw-card-btn'),
                    recoverBtn: document.getElementById('recover-btn'),
                    endTurnBtn: document.getElementById('end-turn-btn'),
                    messageLog: document.getElementById('message-log'),
                };
            }

            addEventListeners() {
                // [ì¶”ê°€] ì¸íŠ¸ë¡œ í™”ë©´ì˜ ê²Œì„ ì‹œì‘ ë²„íŠ¼
                this.dom.gameStartBtn.addEventListener('click', () => {
                    this.dom.introScreen.style.display = 'none';
                    this.prepareTurnOverlay();
                });

                this.dom.startTurnBtn.addEventListener('click', () => this.startTurnProcess());
                this.dom.confirmNewsBtn.addEventListener('click', () => this.enterMainGame());
                
                this.dom.endTurnBtn.addEventListener('click', () => this.switchTurn());
                this.dom.playBtn.addEventListener('click', () => this.handlePlaySelected());
                this.dom.drawCardBtn.addEventListener('click', () => this.handleDrawExtraCard());
                this.dom.recoverBtn.addEventListener('click', () => this.handleRecovery());
                
                this.dom.gameContainer.addEventListener('click', (e) => {
                    const cardEl = e.target.closest('.card');
                    if (cardEl && cardEl.closest('#my-hand')) {
                        this.handleCardClick(cardEl);
                    }
                });
            }
            
            prepareTurnOverlay() {
                this.dom.overlayTitle.textContent = `${this.currentPlayer.name}ë‹˜ì˜ í„´ì…ë‹ˆë‹¤. (ì´ ${this.TURN_LIMIT}í„´ ì¤‘ ${this.currentTurn}í„´)`;
                this.dom.overlay.style.display = 'flex';
                this.dom.gameContainer.style.display = 'none';
            }

            startTurnProcess() {
                this.currentTurn++;
                if (this.currentTurn > this.TURN_LIMIT) {
                    this.endGame(null, true);
                    return;
                }

                // ëœë¤ ë‰´ìŠ¤
                this.currentEvent = EVENTS[Math.floor(Math.random() * EVENTS.length)];
                
                this.dom.newsBadge.textContent = this.currentEvent.badge;
                this.dom.newsBadge.className = `news-badge ${this.currentEvent.bg}`;
                this.dom.newsTitle.textContent = this.currentEvent.name;
                this.dom.newsDesc.innerHTML = this.currentEvent.desc;

                this.dom.overlay.style.display = 'none';
                this.dom.newsModal.style.display = 'flex';
            }

            enterMainGame() {
                this.dom.newsModal.style.display = 'none';
                this.dom.gameContainer.style.display = 'block';
                
                this.dom.tickerText.innerHTML = `[${this.currentEvent.badge}] ${this.currentEvent.name}: ${this.currentEvent.desc}`;
                this.showMessage(`ğŸ“¢ [ë‰´ìŠ¤ ì†ë³´] ${this.currentEvent.name}`, 'log-news');

                this.selectedCardIds = [];
                
                this.currentPlayer.drawCard(this.mainDeck, 1);
                
                const salary = 100;
                this.currentPlayer.currency += salary;
                this.showMessage(`í„´ ìˆ˜ì… +${salary}ì› (í˜„ì¬: ${this.currentPlayer.currency})`, 'log-info');

                this.currentPlayer.actionPoints = 2;
                this.updateButtons();
                this.render();
            }

            switchTurn() {
                if (this.gameOver) return;
                this.currentPlayer = (this.currentPlayer === this.player1) ? this.player2 : this.player1;
                this.prepareTurnOverlay();
            }

            updateButtons() {
                const ap = this.currentPlayer.actionPoints;
                this.dom.playBtn.disabled = (ap < 1);
                this.dom.drawCardBtn.disabled = (ap < 1);
                this.dom.recoverBtn.disabled = (ap < 1);
            }

            render() {
                if (this.gameOver) return;
                const opponent = (this.currentPlayer === this.player1) ? this.player2 : this.player1;

                this.dom.myName.textContent = this.currentPlayer.name;
                this.dom.myCityBadge.innerHTML = `${this.currentPlayer.cityType.name} <span class='weakness-highlight'>(âš ï¸ ${this.currentPlayer.cityType.weakText})</span>`;
                
                this.dom.myAP.textContent = this.currentPlayer.actionPoints;
                this.dom.myCurrency.textContent = this.currentPlayer.currency;
                this.dom.myDamage.textContent = this.currentPlayer.totalDamageTaken;
                
                this.dom.myField.innerHTML = this.currentPlayer.activeMitigations.map(card => this.createCardElement(card, false, false)).join('');
                this.dom.myHand.innerHTML = this.currentPlayer.hand.map(card => this.createCardElement(card, false, false)).join('');
                this.updateDefenseStats();

                this.dom.opponentName.textContent = opponent.name;
                this.dom.opponentCityBadge.textContent = opponent.cityType.name;
                this.dom.opponentCurrency.textContent = opponent.currency;
                this.dom.opponentDamage.textContent = opponent.totalDamageTaken;
                this.dom.opponentField.innerHTML = opponent.activeMitigations.map(card => this.createCardElement(card, false, true)).join('');
                this.dom.opponentHand.innerHTML = opponent.hand.map(card => this.createCardElement(card, true, false)).join('');
            }

            updateDefenseStats() {
                const p = this.currentPlayer;
                const generalCards = p.activeMitigations.filter(c => c.mitigationType === 'general');
                let generalPower = 0;
                if (generalCards.length > 0) {
                    const baseGeneralPower = generalCards.reduce((sum, card) => sum + card.power, 0);
                    generalPower = baseGeneralPower * generalCards.length;
                }
                const snow = p.calculateMitigationPower("ëŒ€ì„¤", true);
                const cold = p.calculateMitigationPower("í•œíŒŒ", true);
                const rain = p.calculateMitigationPower("í­ìš°", true);
                const typhoon = p.calculateMitigationPower("íƒœí’", true);
                
                const fire = p.calculateMitigationPower("ì‚°ë¶ˆ", true);
                const landslide = p.calculateMitigationPower("ì‚°ì‚¬íƒœ", true);
                
                const w = p.cityType.weakType;
                
                const winterClass = w === DisasterType.WINTER ? 'weak' : '';
                const windClass = w === DisasterType.WIND_FLOOD ? 'weak' : '';
                const mountainClass = w === DisasterType.MOUNTAIN ? 'weak' : '';
                
                const winterLabel = w === DisasterType.WINTER ? '<span class="weak-label">âš ï¸ì·¨ì•½</span>' : '';
                const windLabel = w === DisasterType.WIND_FLOOD ? '<span class="weak-label">âš ï¸ì·¨ì•½</span>' : '';
                const mountainLabel = w === DisasterType.MOUNTAIN ? '<span class="weak-label">âš ï¸ì·¨ì•½</span>' : '';

                this.dom.myDefenseStats.innerHTML = `
                    <div style="width:100%; text-align:center; padding-bottom:5px; margin-bottom:5px; border-bottom:1px solid #ccc;">
                        <span style="font-weight:bold; color:#007bff;">ğŸ›¡ï¸ ë²”ìš© ë°©ì¬ë ¥: ${generalPower}</span>
                        <span style="font-size:0.8em; color:#666;">(ëª¨ë“  ì¬ë‚œ ë°©ì–´ë ¥ì— ìë™ í•©ì‚°ë¨)</span>
                    </div>
                    <div class="defense-row">
                        <div class="def-category ${winterClass}">
                            <div class="def-title">â„ï¸ ê²¨ìš¸ ${winterLabel}</div>
                            <div class="def-item"><span>ëŒ€ì„¤</span><span class="def-val">${snow}</span></div>
                            <div class="def-item"><span>í•œíŒŒ</span><span class="def-val">${cold}</span></div>
                        </div>
                        <div class="def-category ${windClass}">
                            <div class="def-title">â›ˆï¸ í’ìˆ˜í•´ ${windLabel}</div>
                            <div class="def-item"><span>í­ìš°</span><span class="def-val">${rain}</span></div>
                            <div class="def-item"><span>íƒœí’</span><span class="def-val">${typhoon}</span></div>
                        </div>
                        <div class="def-category ${mountainClass}">
                            <div class="def-title">â›°ï¸ ì‚°ì•… ${mountainLabel}</div>
                            <div class="def-item"><span>ì‚°ë¶ˆ</span><span class="def-val">${fire}</span></div>
                            <div class="def-item"><span>ì‚°ì‚¬íƒœ</span><span class="def-val">${landslide}</span></div>
                        </div>
                    </div>
                `;
            }

            createCardElement(card, isHiddenInHand, isHiddenOnField) {
                if (isHiddenInHand) return `<div class="card hidden"></div>`;
                
                let typeClass = `type-${card.cardType}`;
                let cardName = card.name;
                let details = '';

                let displayCost = card.cost;
                let costStyle = "";
                if (!isHiddenInHand && !isHiddenOnField && card.cardType !== 'disaster') {
                    if (this.currentEvent.type === 'cost_up') { displayCost += this.currentEvent.val; costStyle = "color:#d32f2f; font-weight:bold;"; }
                    if (this.currentEvent.type === 'cost_down') { displayCost = Math.max(0, displayCost - this.currentEvent.val); costStyle = "color:#1976d2; font-weight:bold;"; }
                }

                if (isHiddenOnField) {
                    typeClass = 'obfuscated';
                    details = `<div class="card-type">(ì„¤ì¹˜ë¨)</div>`;
                    if (card.mitigationType === 'general') cardName = 'ë²”ìš© ë°©ì¬ ì‹œì„¤';
                    else {
                        const winter = ["ëŒ€ì„¤", "í•œíŒŒ"];
                        const wind_flood = ["í­ìš°", "íƒœí’"];
                        const mountain = ["ì‚°ë¶ˆ", "ì‚°ì‚¬íƒœ"];
                        
                        if (winter.includes(card.disasterTarget)) cardName = 'ê²¨ìš¸ì²  ë°©ì¬ ì‹œì„¤';
                        else if (wind_flood.includes(card.disasterTarget)) cardName = 'í’ìˆ˜í•´ ë°©ì¬ ì‹œì„¤';
                        else if (mountain.includes(card.disasterTarget)) cardName = 'ì‚°ì•… ì¬ë‚œ ë°©ì¬ ì‹œì„¤';
                        else cardName = 'íŠ¹ì • ë°©ì¬ ì‹œì„¤';
                    }
                } else if (card.cardType === 'disaster') {
                    let displayDmg = card.baseDamage;
                    let dmgStyle = "";
                    if (this.currentEvent.type === 'attack_buff') {
                        displayDmg = Math.floor(displayDmg * this.currentEvent.val);
                        dmgStyle = "color:#d32f2f; font-weight:bold;";
                    }
                    details = `<div class="card-power" style="${dmgStyle}">í”¼í•´: ${displayDmg}</div><div class="card-type">${card.disasterType}</div>`;
                } else {
                    details = `<div class="card-cost" style="${costStyle}">ë¹„ìš©: ${displayCost}</div><div class="card-power">ë°©ì¬ë ¥: ${card.power}</div><div class="card-type">${card.phase}</div>`;
                }
                
                const isSelected = this.selectedCardIds.includes(card.id);
                return `<div class="card ${isSelected ? 'selected' : ''} ${typeClass}" data-card-id="${card.id}"><div class="card-name">${cardName}</div>${details}</div>`;
            }

            handleCardClick(clickedCardElement) {
                const cardId = clickedCardElement.dataset.cardId;
                if (!cardId) return;
                
                if (this.currentPlayer.actionPoints < 1 && !this.selectedCardIds.includes(cardId)) {
                    this.showMessage("APê°€ ë¶€ì¡±í•˜ì—¬ ë” ì´ìƒ ì¹´ë“œë¥¼ ì„ íƒí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", 'log-info');
                    return;
                }
                
                if (this.selectedCardIds.includes(cardId)) {
                    this.selectedCardIds = this.selectedCardIds.filter(id => id !== cardId);
                } else {
                    this.selectedCardIds.push(cardId);
                }
                
                this.render();
            }

            handlePlaySelected() {
                const selectedCards = this.currentPlayer.hand.filter(card => this.selectedCardIds.includes(card.id));
                const numCards = selectedCards.length;
                
                if (numCards === 0) { this.showMessage("ì¹´ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”.", 'log-info'); return; }
                if (this.currentPlayer.actionPoints < numCards) { this.showMessage("AP ë¶€ì¡±", 'log-info'); return; }
                
                const mitigationCards = selectedCards.filter(c => c instanceof MitigationCard);
                const disasterCards = selectedCards.filter(c => c instanceof DisasterCard);
                
                let totalCost = 0;
                mitigationCards.forEach(card => {
                    let cost = card.cost;
                    if (this.currentEvent.type === 'cost_up') cost += this.currentEvent.val;
                    if (this.currentEvent.type === 'cost_down') cost = Math.max(0, cost - this.currentEvent.val);
                    totalCost += cost;
                });

                if (this.currentPlayer.currency < totalCost) {
                    this.showMessage(`ë¹„ìš© ë¶€ì¡± (í•„ìš”: ${totalCost})`, 'log-info'); return;
                }

                this.currentPlayer.currency -= totalCost;
                this.currentPlayer.actionPoints -= numCards;

                this.playMitigationCards(mitigationCards);
                this.playDisasterCards(disasterCards);
                
                if (mitigationCards.length > 0) this.showMessage(`ë°©ì¬ ì¹´ë“œ ${mitigationCards.length}ì¥ ì„¤ì¹˜ (ë¹„ìš©: ${totalCost})`, 'log-action');
                
                this.selectedCardIds = [];
                this.updateButtons();
                this.render();
            }

            handleDrawExtraCard() {
                if (this.currentPlayer.actionPoints < 1) { this.showMessage("AP ë¶€ì¡±", 'log-info'); return; }
                this.currentPlayer.actionPoints -= 1;
                this.currentPlayer.drawCard(this.mainDeck, 1);
                this.showMessage("ì¹´ë“œ ë½‘ê¸° ì™„ë£Œ", 'log-draw');
                this.updateButtons();
                this.render();
            }

            handleRecovery() {
                if (this.currentPlayer.actionPoints < 1) { this.showMessage("AP ë¶€ì¡±", 'log-info'); return; }
                if (this.currentPlayer.totalDamageTaken <= 0) { this.showMessage("í”¼í•´ ì—†ìŒ", 'log-info'); return; }
                
                let multiplier = 2;
                if (this.currentEvent.type === 'recover_nerf') multiplier = 3;
                if (this.currentEvent.type === 'recover_buff') multiplier = 1.5;

                const maxRecoverable = Math.floor(this.currentPlayer.currency / multiplier);
                const realMax = Math.min(this.currentPlayer.totalDamageTaken, maxRecoverable);

                if (realMax <= 0) { this.showMessage(`ì˜ˆì‚° ë¶€ì¡± (ë¹„ìš© ë°°ìœ¨: x${multiplier})`, 'log-info'); return; }

                const input = prompt(`ë³µêµ¬í•  í”¼í•´ëŸ‰ ì…ë ¥ (ìµœëŒ€ ${realMax})\ní˜„ì¬ ë¹„ìš© ë°°ìœ¨: x${multiplier}`);
                if (input === null) return;
                const amount = parseInt(input);
                
                if (isNaN(amount) || amount <= 0 || amount > realMax) { this.showMessage("ìœ íš¨í•œ ìˆ«ì ì…ë ¥ ìš”ë§", 'log-info'); return; }

                const cost = Math.floor(amount * multiplier);
                this.currentPlayer.currency -= cost;
                this.currentPlayer.totalDamageTaken -= amount;
                this.currentPlayer.actionPoints -= 1;

                this.showMessage(`í”¼í•´ ${amount} ë³µêµ¬ ì™„ë£Œ (ë¹„ìš©: ${cost})`, 'log-action');
                this.updateButtons();
                this.render();
            }

            playMitigationCards(cards) {
                cards.forEach(card => {
                    this.currentPlayer.hand = this.currentPlayer.hand.filter(c => c.id !== card.id);
                    this.currentPlayer.activeMitigations.push(card);
                });
            }

            playDisasterCards(cards) {
                if (cards.length === 0) return;
                const opponent = (this.currentPlayer === this.player1) ? this.player2 : this.player1;

                if (cards.length === 1) {
                    const card = cards[0];
                    this.currentPlayer.hand = this.currentPlayer.hand.filter(c => c.id !== card.id);
                    
                    let dmg = card.baseDamage;
                    if(this.currentEvent.type === 'attack_buff') dmg = Math.floor(dmg * this.currentEvent.val);

                    opponent.takeDamage(dmg, card.name, card.disasterType, this.currentEvent);
                    this.currentPlayer.drawCard(this.mainDeck, 1);
                } 
                else if (cards.length === 2 && cards[0].disasterType === cards[1].disasterType) {
                    const [card1, card2] = cards;
                    let baseDmg = card1.baseDamage + card2.baseDamage;
                    if(this.currentEvent.type === 'attack_buff') baseDmg = Math.floor(baseDmg * this.currentEvent.val);
                    
                    const comboDmg = baseDmg * 2; 
                    
                    this.showMessage(`[ì¬ë‚œ ì½¤ë³´] ${card1.disasterType} ì—°ì‡„ ë°œìƒ!`, 'log-damage');
                    this.currentPlayer.hand = this.currentPlayer.hand.filter(c => c.id !== card1.id && c.id !== card2.id);
                    opponent.takeDamage(comboDmg, `${card1.name} & ${card2.name}`, card1.disasterType, this.currentEvent);
                    this.currentPlayer.drawCard(this.mainDeck, 2);
                } 
                else if (cards.length > 0) {
                    this.showMessage("ì¬ë‚œ ì½¤ë³´ ì‹¤íŒ¨ (ìœ í˜• ë¶ˆì¼ì¹˜)", 'log-info');
                    cards.forEach(card => {
                        this.currentPlayer.hand = this.currentPlayer.hand.filter(c => c.id !== card.id);
                        let dmg = card.baseDamage;
                        if(this.currentEvent.type === 'attack_buff') dmg = Math.floor(dmg * this.currentEvent.val);
                        opponent.takeDamage(dmg, card.name, card.disasterType, this.currentEvent);
                        this.currentPlayer.drawCard(this.mainDeck, 1);
                    });
                }
            }
            
            showMessage(msg, type) {
                const p = document.createElement('p'); p.innerHTML = msg; p.className = type;
                this.dom.messageLog.appendChild(p);
                this.dom.messageLog.scrollTop = this.dom.messageLog.scrollHeight;
            }

            endGame(loser, isTimeLimit = false) {
                this.gameOver = true;
                let msg = "";
                let subMsg = "";
                let winner;

                if (isTimeLimit) {
                    const p1 = this.player1.totalDamageTaken;
                    const p2 = this.player2.totalDamageTaken;
                    if (p1 < p2) { msg = `${this.player1.name} ìŠ¹ë¦¬!`; subMsg = "ìµœì†Œ í”¼í•´ ë°©ì–´ ì„±ê³µ"; winner = this.player1; }
                    else if (p2 < p1) { msg = `${this.player2.name} ìŠ¹ë¦¬!`; subMsg = "ìµœì†Œ í”¼í•´ ë°©ì–´ ì„±ê³µ"; winner = this.player2; }
                    else { msg = "ë¬´ìŠ¹ë¶€"; subMsg = "í”¼í•´ëŸ‰ì´ ë™ì¼í•©ë‹ˆë‹¤."; winner = null; }
                } else {
                    winner = (loser === this.player1) ? this.player2 : this.player1;
                    msg = `${winner.name} ìŠ¹ë¦¬!`;
                    subMsg = "ìƒëŒ€ë°© ë„ì‹œ íŒŒì‚°";
                }

                this.dom.overlay.style.display = 'flex';
                this.dom.overlayTitle.textContent = "ğŸ† ê²Œì„ ì¢…ë£Œ ğŸ†";
                this.dom.overlayTitle.style.color = "#FFD700"; // Gold color
                
                // ê²°ê³¼ ìš”ì•½ í…Œì´ë¸” ìƒì„±
                const summaryHTML = `
                    <div class="summary-box">
                        <div style="font-size:1.5em; font-weight:bold; text-align:center; margin-bottom:10px;">${msg}</div>
                        <div style="text-align:center; color:#ccc; margin-bottom:20px;">(${subMsg})</div>
                        <table class="summary-table">
                            <thead>
                                <tr>
                                    <th>í•­ëª©</th>
                                    <th>${this.player1.name}</th>
                                    <th>${this.player2.name}</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>ëˆ„ì  í”¼í•´</td>
                                    <td class="val-bad">${this.player1.totalDamageTaken}</td>
                                    <td class="val-bad">${this.player2.totalDamageTaken}</td>
                                </tr>
                                <tr>
                                    <td>ë‚¨ì€ ì˜ˆì‚°</td>
                                    <td class="val-good">${this.player1.currency}</td>
                                    <td class="val-good">${this.player2.currency}</td>
                                </tr>
                                <tr>
                                    <td>ì§„í–‰ í„´</td>
                                    <td colspan="2" style="text-align:center">${this.currentTurn} / ${this.TURN_LIMIT}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                `;

                this.dom.overlayContent.innerHTML = summaryHTML;
                document.getElementById('start-turn-btn').style.display = 'none';
                
                if(!document.getElementById('restart-btn')) {
                    const btn = document.createElement('button');
                    btn.id = 'restart-btn';
                    btn.textContent = "ë‹¤ì‹œ í•˜ê¸°";
                    btn.style.fontSize = "1.5em"; btn.style.padding = "15px 40px"; btn.style.marginTop = "20px";
                    btn.style.cursor = "pointer"; btn.style.backgroundColor = "#28a745"; btn.style.color = "white"; btn.style.border = "none"; btn.style.borderRadius = "8px";
                    btn.onclick = () => location.reload();
                    this.dom.overlay.appendChild(btn);
                }
            }
        }
        
        let game;
        document.addEventListener('DOMContentLoaded', () => { game = new GameManager(); });
    </script>
</body>
</html>